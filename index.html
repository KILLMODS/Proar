<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Proar Messenger</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root {
  --bg: #f0f0f0;
  --header-bg: #fff;
  --sidebar-bg: #fff;
  --text-color: #222;
  --muted: #777;
  --bubble-recv: #e0e0e0;
  --bubble-send: #4caf50;
  --border-color: #ddd;
  --accent-color: #007aff;
  --primary-color: #007aff;
  --btn-hover: #006ae0;
  --button-gradient: linear-gradient(135deg, #56ab2f, #a8e063);
}
body.dark {
  --bg: #222;
  --header-bg: #111;
  --sidebar-bg: #222;
  --text-color: #eee;
  --muted: #aaa;
  --bubble-recv: #555;
  --bubble-send: #338a38;
  --border-color: #444;
  --accent-color: #339aff;
}
body {
  margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg); color: var(--text-color); height: 100vh;
  display: flex; flex-direction: column;
}
/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
.header {
  height: 60px; background: var(--header-bg);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: sticky; top: 0; z-index: 50; flex-wrap: wrap;
}
.header .title { display: flex; align-items: center; font-size: 20px; font-weight: 600; }
#logo-text { font-weight: bold; font-size: 22px; color: #222; font-family: 'Arial Black', sans-serif; }
body.dark #logo-text { color: #eee; }
.header .buttons {
  display: flex; align-items: center;
}
.header .buttons button {
  background: transparent; border: none; margin-left: 10px; font-size: 20px; cursor: pointer;
  padding: 8px 12px; border-radius: 6px; transition: background 0.2s, transform 0.2s;
}
.header .buttons button:hover { background: rgba(0,0,0,0.05); }
body.dark .header .buttons button:hover { background: rgba(255,255,255,0.1); }

.container {
  flex: 1; display: flex; overflow: hidden; min-height: calc(100vh - 60px);
}

aside.sidebar {
  width: 250px; max-width: 300px;
  background: var(--sidebar-bg);
  display: flex; flex-direction: column;
  transition: transform 0.3s ease, width 0.3s ease;
  transform: translateX(-100%);
  position: relative;
  z-index: 40;
}
aside.sidebar.open { transform: translateX(0); }
.sidebar .toggle-btn {
  position: absolute; top: 10px; right: -40px; width: 40px; height: 40px;
  background: #007aff; color: #fff; display: flex; align-items: center; justify-content: center;
  border-radius: 0 4px 4px 0; cursor: pointer; box-shadow: 0 0 4px rgba(0,0,0,0.3);
  font-size: 20px; transition: background 0.2s;
}
body.dark .sidebar .toggle-btn { background:#339aff; }
.sidebar-header {
  padding: 16px 16px 8px; display:flex; flex-direction:column; align-items: center;
  border-bottom: 1px solid var(--border-color);
}
#profile-avatar {
  width:80px; height:80px; background:#bbb; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:36px; color:#fff; margin-bottom:8px; background-size:cover; background-position:center;
}
body.dark #profile-avatar { background:#555; }
#profile-name-sidebar {
  font-weight:600; font-size:16px; margin-bottom:4px;
}
#profile-status-sidebar {
  font-size:14px; color:var(--muted);
}
.menu-buttons {
  margin-top:12px; width:100%; display:flex; flex-direction:column; gap:8px;
}
.menu-buttons button {
  padding:10px; border:none; border-radius:6px; font-weight:600; font-size:14px; cursor:pointer;
  background: #007aff; color:#fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background 0.2s, transform 0.2s;
}
body.dark .menu-buttons button { background:#339aff; }
.menu-buttons button:hover { background:#005bb5; transform: translateY(-2px); }
#search-panel {
  display: none; padding: 8px 16px; background:#fafafa; border-bottom:1px solid var(--border-color);
}
#search-panel.active { display: block; }
#search-input {
  width: 100%; padding:8px 12px; border-radius:20px; border:1px solid #ccc; font-size:14px;
}
body.dark #search-input { background:#333; border-color:#555; color:#eee; }
#search-results {
  margin-top:10px; max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:8px; padding:8px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
#search-results .chat-item {
  display:flex; align-items:center; padding:8px; cursor:pointer; border-bottom:1px solid var(--border-color); border-radius:4px;
}
#search-results .chat-item:hover { background:#f0f0f0; }
#search-results .chat-item:last-child { border-bottom:none; }
#chats {
  flex:1; overflow-y:auto; padding:10px;
}
.chat-item {
  display:flex; align-items:center; padding:10px; cursor:pointer; border-bottom:1px solid var(--border-color);
  transition: background 0.2s;
}
.chat-item:hover { background:#f5f5f5; }
.chat-item.active { background:#e0e0e0; }
body.dark .chat-item:hover { background:#444; }
body.dark .chat-item.active { background:#555; }
.avatar {
  width:50px; height:50px; background:#ccc; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight: bold; font-size:20px; color:#fff; margin-right:12px; background-size:cover; background-position:center;
}
body.dark .avatar { background:#666; }
.chat-info { flex:1; display:flex; flex-direction:column; }
.chat-name { font-weight:600; font-size:14px; margin-bottom:4px; }

section#main {
  flex:1; display:flex; flex-direction:column;
}
#chat-header {
  padding:12px 20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; background:#fafafa;
}
#chat-title { font-weight:600; font-size:16px; display:flex; align-items:center; }
#profile-badge {
  width:16px; height:16px; background:#3b82f6; border-radius:50%; margin-left:6px; display:flex; align-items:center; justify-content:center; font-size:10px; color:#fff; font-weight:bold;
}
#messages {
  flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;
}
.message {
  max-width:70%; padding:10px 14px; border-radius:20px; margin-bottom:8px; position:relative;
  word-wrap:break-word; font-size:14px; box-shadow:0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.2s; background: var(--bubble-recv);
}
.message.sent { align-self: flex-end; background: var(--bubble-send); color:#fff; }
.message.recv { background: var(--bubble-recv); color:#222; }
.message .time { font-size:10px; color:#555; margin-top:4px; text-align:right; }
.reply-preview {
  font-size:12px; color:#555; border-left:3px solid #ccc; padding-left:8px; margin-bottom:6px;
}
.message img { max-width:260px; border-radius:8px; margin-top:8px; transition:transform 0.2s; }
.message img:hover { transform:scale(1.05); }
#input-area {
  display:flex; padding:8px 16px; border-top:1px solid var(--border-color);
  background:#fafafa; align-items:center; gap:8px; position:relative;
}
#message-input {
  flex:1; padding:10px 14px; border-radius:20px; border: 1px solid #ccc; background:#fff; font-size:14px;
}
#message-input:focus { outline:none; background:#fefefe; }
#file-label {
  cursor:pointer; font-size:20px; display:flex; align-items:center; padding:6px 10px; border-radius:20px; background:#007aff; color:#fff; transition: background 0.2s, transform 0.2s;
}
#file-input { display:none; }
#send-btn {
  background:#4caf50; border:none; padding:8px 14px; border-radius:20px; color:#fff; cursor:pointer; font-size:14px; transition: background 0.2s, transform 0.2s;
}
#send-btn:hover { background:#3e8e41; transform:scale(1.05); }
#emoji-btn {
  background: transparent; border:none; font-size:20px; cursor:pointer; margin-left:auto; color:#555; transition: color 0.2s;
}
#emoji-btn:hover { color: #007aff; }
#emoji-picker {
  position: absolute; bottom: 60px; right: 20px; width: 250px; max-height: 300px; overflow-y: auto; background: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px;
}
.emoji {
  font-size: 20px; padding: 4px; cursor:pointer; text-align: center; transition: background 0.2s; border-radius: 4px;
}
.emoji:hover { background:#f0f0f0; }
#voice-recording-indicator {
  position: absolute; bottom: 60px; left: calc(50% - 50px);
  width: 100px; height: 100px; background: radial-gradient(circle, #56ab2f, #a8e063);
  border-radius:50%; display:flex; align-items:center; justify-content:center;
  font-size:14px; color:#fff; font-weight:bold; animation:pulse 1s infinite;
  opacity:0; transition:opacity 0.3s;
}
#voice-recording-indicator.show { opacity:1; }
@keyframes pulse {
  0% { transform:scale(1); }
  50% { transform:scale(1.2); }
  100% { transform:scale(1); }
}
/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
#profile-panel {
  display:none; position:fixed; top:70px; right:20px; background:#fff; padding:20px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.4); z-index:9999; width:300px; max-height:80vh; overflow-y:auto;
}
#profile-panel.show { display:block; }
#extended-chat-creation {
  display:none; position:fixed; top:70px; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;
}
#extended-chat-creation > div {
  background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%; display:flex; flex-direction:column; gap:8px;
}
@media(max-width: 900px) {
  aside.sidebar {
    position: absolute; top:0; left:0; height: 100%; z-index: 999;
  }
}
</style>
</head>
<body class="dark">
<div class="header">
  <div style="display:flex; align-items:center;">
    <button id="sidebar-toggle" style="background:none; border:none; font-size:20px; cursor:pointer; margin-right:10px;"><i class="fas fa-bars"></i></button>
    <span id="logo-text">Proar</span>
  </div>
  <div class="buttons">
    <button title="–ü—Ä–æ—Ñ–∏–ª—å" onclick="showProfile()"><i class="fas fa-user"></i></button>
    <button title="–°–æ–∑–¥–∞—Ç—å" onclick="openExtendedChat()"><i class="fas fa-plus"></i></button>
    <button title="–¢–µ–º–∞" id="theme-toggle"><i class="fas fa-moon"></i></button>
    <button title="–í—ã–π—Ç–∏" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
  </div>
</div>
<div class="container">
  <aside class="sidebar" id="sidebar">
    <div class="toggle-btn" id="sidebar-toggle-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å"><i class="fas fa-angle-right"></i></div>
    <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; flex-direction:column; align-items: center;">
      <div id="profile-avatar">üòä</div>
      <div style="margin-top:8px; font-weight:600; font-size:16px;" id="profile-name-sidebar">–ì–æ—Å—Ç—å</div>
      <div style="margin-top:4px; font-size:14px; color:var(--muted);" id="profile-status-sidebar">–û–Ω–ª–∞–π–Ω</div>
      <div class="menu-buttons">
        <button onclick="showProfile()">–ü—Ä–æ—Ñ–∏–ª—å</button>
        <button onclick="showStatus()">–°—Ç–∞—Ç—É—Å</button>
        <button onclick="openSettings()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>
    <div class="sidebar-header" style="margin-top:10px;"><h3 style="margin:0;">–ú–æ–∏ —á–∞—Ç—ã</h3></div>
    <button id="new-chat-btn" style="margin-top:8px; padding:8px; border:none; border-radius:6px; background: var(--primary-color); color:#fff; font-weight:600; cursor:pointer; width:100%; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;" onclick="openExtendedChat()">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
    <button id="search-username-btn" style="margin-top:8px; padding:8px; border:none; border-radius:6px; background: var(--primary-color); color:#fff; font-weight:600; cursor:pointer; width:100%; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;" onclick="toggleSearchResults()">–ü–æ–∏—Å–∫ –ø–æ username</button>
    <div id="search-panel">
      <input id="search-input" placeholder="–ü–æ–∏—Å–∫..." style="width:100%; padding:8px 12px; border-radius:20px; border:1px solid #ccc; margin-top:8px; font-size:14px;"/>
    </div>
    <div id="search-results" style="margin-top:10px; max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:8px; padding:8px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.2); display:none;"></div>
    <div id="chats"></div>
  </aside>
  <section class="main" id="main" style="flex:1; display:flex; flex-direction:column;">
    <div id="chat-header" style="padding:12px 20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; background:#fafafa;">
      <div style="display:flex; align-items:center; gap:8px;">
        <span id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
        <span id="chat-status"></span>
        <span id="profile-badge" style="display:none;">‚úî</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="archiveChat()" style="padding:6px 12px; border:none; border-radius:6px; background:var(--primary-color); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;">–ê—Ä—Ö–∏–≤</button>
        <button onclick="showFullChat()" style="padding:6px 12px; border:none; border-radius:6px; background:var(--primary-color); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
        <button onclick="showProfile()" style="padding:6px 12px; border:none; border-radius:6px; background:var(--primary-color); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;"><i class="fas fa-cog"></i></button>
      </div>
    </div>
    <div id="messages" style="flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;"></div>
    <form id="input-area" onsubmit="event.preventDefault(); sendMessage()" style="padding:8px 16px; display:flex; align-items:center; gap:8px; border-top:1px solid var(--border-color); background:#fafafa; position:relative;">
      <label id="file-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" style="cursor:pointer; font-size:20px; display:flex; align-items:center; padding:6px 10px; border-radius:20px; background:#007aff; color:#fff; transition: background 0.2s, transform 0.2s;"><i class="fas fa-paperclip"></i></label>
      <input type="file" id="file-input" style="display:none"/>
      <input id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1; padding:10px 14px; border-radius:20px; border:1px solid #ccc; background:#fff; font-size:14px;"/>
      <button id="send-btn" type="submit" style="padding:8px 14px; border:none; border-radius:20px; background:#4caf50; color:#fff; cursor:pointer; font-size:14px; transition: background 0.2s, transform 0.2s;"><i class="fas fa-paper-plane"></i></button>
      <button type="button" id="emoji-btn" title="–≠–º–æ–¥–∑–∏" style="background: transparent; border:none; font-size:20px; cursor:pointer; margin-left:auto; color:#555; transition: color 0.2s;"><i class="fas fa-smile"></i></button>
      <button type="button" id="voice-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å" style="margin-left:8px; background:linear-gradient(135deg, #43e97b, #38f9d7); border:none; padding:8px 14px; border-radius:20px; cursor:pointer; transition:transform 0.2s;"><i class="fas fa-microphone"></i></button>
    </form>
    <div id="emoji-picker"></div>
    <div id="voice-recording-indicator" style="display:none;">–ó–∞–ø–∏—Å—å...</div>
    <div id="recaptcha-container"></div>
  </section>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div id="profile-panel" style="display:none; position:fixed; top:70px; right:20px; background:#fff; padding:20px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.4); z-index:9999; width:300px; max-height:80vh; overflow-y:auto;">
<h3 style="margin-top:0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
<div style="display:flex; flex-direction:column; gap:8px;">
<input id="profile-name" placeholder="–ò–º—è" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"/>
<input id="profile-username" placeholder="Username" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"/>
<input id="profile-avatar-url" placeholder="URL –ê–≤–∞—Ç–∞—Ä–∞" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"/>
<input id="profile-status" placeholder="–°—Ç–∞—Ç—É—Å" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"/>
<div style="display:flex; justify-content:space-between; margin-top:12px;">
<button class="btn" style="padding:8px 16px; border:none; border-radius:6px; background:var(--primary-color); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button class="btn-secondary" style="padding:8px 16px; border:none; border-radius:6px; background:#999; color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);" onclick="closeProfile()">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>
</div>

<div id="extended-chat-creation" style="display:none; position:fixed; top:70px; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;">
<div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%; display:flex; flex-direction:column; gap:8px;">
<h3 style="margin-top:0;">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h3>
<input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" id="ext-chat-name" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"/>
<input placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" id="ext-chat-description" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"/>
<div style="margin-top:12px;">
<label><input type="radio" name="chat-type" value="public" checked> –ü—É–±–ª–∏—á–Ω—ã–π</label>
<label style="margin-left:20px;"><input type="radio" name="chat-type" value="private"> –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</label>
</div>
<div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
<button class="btn" style="padding:8px 16px; border:none; border-radius:6px; background:var(--primary-color); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);" onclick="createExtendedChat()">–°–æ–∑–¥–∞—Ç—å</button>
<button class="btn-secondary" style="padding:8px 16px; border:none; border-radius:6px; background:#999; color:#fff; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);" onclick="closeExtendedChat()">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB-R3yavvxAaMeJ6bi_RneFuMkrqmHyE5g",
    authDomain: "proar-3cf77.firebaseapp.com",
    projectId: "proar-3cf77",
    storageBucket: "proar-3cf77.appspot.com",
    messagingSenderId: "676918837096",
    appId: "1:676918837096:web:c7dbd6f8e44fcf230f60dd"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let currentChatId = null;
let chatsUnsub = null;
let messagesUnsub = null;
let replyToMessageId = null;
let themeDark = true;
let sidebarExpanded = false;
let confirmationResult = null;
let phoneAuthInProgress = false;

const groupColors = ["#FF5733","#33FF57","#3357FF","#F333FF","#33FFF5","#FF33A8","#A833FF","#33FFA8"];

// –¢–µ–º–∞
if (localStorage.getItem('theme') === 'light') {
  themeDark = false;
  document.body.classList.remove('dark');
} else {
  themeDark = true;
  document.body.classList.add('dark');
}
document.getElementById('theme-toggle').onclick=()=> {
  themeDark = !themeDark;
  document.body.classList.toggle('dark', themeDark);
  localStorage.setItem('theme', themeDark ? 'dark' : 'light');
};
document.getElementById('sidebar-toggle').onclick=()=>{ toggleSidebar(); };
document.getElementById('sidebar-toggle-btn').onclick=()=>{ toggleSidebar(); };
function toggleSidebar() {
  sidebarExpanded = !sidebarExpanded;
  const sidebar = document.getElementById('sidebar');
  if (sidebarExpanded) {
    sidebar.classList.add('open');
    document.getElementById('sidebar-toggle-btn').innerHTML = '<i class="fas fa-angle-left"></i>';
  } else {
    sidebar.classList.remove('open');
    document.getElementById('sidebar-toggle-btn').innerHTML = '<i class="fas fa-angle-right"></i>';
  }
}

// –≠–º–æ–¥–∑–∏
const emojis = ['üòÄ','üòÅ','üòÇ','ü§£','üòÉ','üòÑ','üòÖ','üòÜ','üòâ','üòä','üòã','üòé','üòç','ü•∞','üòò','üòó','üòô','üòö','üôÇ','ü§ó','ü§©','ü§î','ü§®','üòê','üòë','üò∂','üôÑ','üòè','üò£','üò•','üòÆ','ü§ê','üòØ','üò™','üò´','üò¥','üòå','ü•±','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§†','üòè'];
function initEmoji() {
  const picker = document.getElementById('emoji-picker');
  picker.innerHTML = '';
  emojis.forEach(e => {
    const div = document.createElement('div');
    div.className='emoji';
    div.textContent=e;
    div.onclick=()=>{ insertAtCursor(document.getElementById('message-input'), e); hideEmoji(); };
    picker.appendChild(div);
  });
}
function toggleEmoji() {
  const p=document.getElementById('emoji-picker');
  if (p.style.display==='grid') hideEmoji(); else showEmoji();
}
function showEmoji() { document.getElementById('emoji-picker').style.display='grid'; }
function hideEmoji() { document.getElementById('emoji-picker').style.display='none'; }
function insertAtCursor(input, text) {
  const start = input.selectionStart;
  const end = input.selectionEnd;
  input.value = input.value.substring(0,start)+text+input.value.substring(end);
  input.focus();
  input.selectionStart=start+text.length;
  input.selectionEnd=start+text.length;
}
document.getElementById('emoji-btn').onclick=toggleEmoji;
document.getElementById('message-input').addEventListener('keydown', (e)=> {
  if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
document.getElementById('file-label').onclick=()=>{ document.getElementById('file-input').click(); };
initEmoji();

// –•–µ–ª–ø–µ—Ä—ã
function encodeText(str){return btoa(unescape(encodeURIComponent(str))); }
function decodeText(str){ return decodeURIComponent(escape(atob(str))); }

// –í—Ö–æ–¥ —á–µ—Ä–µ–∑ email
async function loginWithEmail(email, pass) {
  const cred = await auth.signInWithEmailAndPassword(email, pass);
  return cred.user;
}
async function registerWithEmail(name, username, email, pass) {
  const cred = await auth.createUserWithEmailAndPassword(email, pass);
  const user=cred.user;
  await db.collection('users').doc(user.uid).set({
    name, username, email, status:'–û–Ω–ª–∞–π–Ω', avatarUrl:'', initials: name.charAt(0).toUpperCase()
  });
  return user;
}

// Phone auth helpers
function setupRecaptcha() {
  window.recaptchaVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'invisible'});
  window.recaptchaVerifier.render();
}
async function sendOtpForPhone(phoneNumber) {
  if (!window.recaptchaVerifier) setupRecaptcha();
  try {
    confirmationResult=await firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
    phoneAuthInProgress=true;
    alert('SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.');
    return true;
  } catch(e) {
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: '+e.message);
    return false;
  }
}
async function verifyOtp(code) {
  if (!confirmationResult) { alert('–ù–µ—Ç –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'); return null; }
  try {
    const result=await confirmationResult.confirm(code);
    return result.user;
  } catch(e) {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: '+e.message);
    return null;
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ auth
firebase.auth().onAuthStateChanged(async (user)=> {
  if (user) {
    currentUser=user;
    await ensureUserProfile();
    await initAfterLogin();
  } else {
    showLoginModal();
  }
});
async function ensureUserProfile() {
  if (!currentUser) return;
  const docRef=db.collection('users').doc(currentUser.uid);
  const snap=await docRef.get();
  if (!snap.exists) {
    const phone=currentUser.phoneNumber||'';
    const initials=phone.slice(-2);
    await docRef.set({ name:'', username:'', email:currentUser.email||'', phone, status:'–û–Ω–ª–∞–π–Ω', avatarUrl:'', initials });
  }
}
async function showLoginModal() {
  if (document.getElementById('auth-modal')) return;
  const div=document.createElement('div');
  div.id='auth-modal';
  div.style.position='fixed'; div.style.top='0'; div.style.left='0'; div.style.right='0'; div.style.bottom='0';
  div.style.background='rgba(0,0,0,0.8)'; div.style.display='flex'; div.style.alignItems='center'; div.style.justifyContent='center'; div.style.zIndex='9999';
  div.innerHTML=`
  <div style="background:#fff; padding:20px; border-radius:8px; width:420px; display:flex; flex-direction:column; gap:12px; color:#222;">
    <h3 style="margin:0; text-align:center;">–í—Ö–æ–¥ –∏–ª–∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <div style="display:flex; gap:8px; justify-content: center;">
      <button onclick="showEmailAuth()" style="padding:8px 12px; border-radius:6px; border:1px solid #ccc;">Email</button>
      <button onclick="showPhoneAuth()" style="padding:8px 12px; border-radius:6px; border:1px solid #ccc;">–¢–µ–ª–µ—Ñ–æ–Ω</button>
      <button onclick="showGitHubAuth()" style="padding:8px 12px; border-radius:6px; border:1px solid #ccc;">GitHub</button>
    </div>
    <div id="auth-content" style="display:flex; flex-direction:column; gap:8px; padding:8px 0;"></div>
    <div id="recaptcha-container"></div>
  </div>`;
  document.body.appendChild(div);
}
function showEmailAuth() {
  document.getElementById('auth-content').innerHTML=`
    <input id="email-input" placeholder="Email" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
    <input id="password-input" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
    <button onclick="handleEmailLogin()" style="width:100%; padding:8px; border:none; border-radius:6px; background:var(--primary-color); color:#fff;">–í–æ–π—Ç–∏</button>
    <button onclick="handleEmailRegisterForm()" style="width:100%; padding:8px; border:none; border-radius:6px; background:#666; color:#fff;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  `;
}
function showPhoneAuth() {
  document.getElementById('auth-content').innerHTML=`
    <input id="phone-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7...)" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
    <button onclick="sendPhoneOtp()" style="width:100%; padding:8px; border:none; border-radius:6px; background:var(--primary-color); color:#fff;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
    <input id="otp-input" placeholder="–ö–æ–¥ –∏–∑ SMS" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
    <button onclick="verifyPhoneOtp()" style="width:100%; padding:8px; border:none; border-radius:6px; background:#28a745; color:#fff;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  `;
  setupRecaptcha();
}
async function handleEmailLogin() {
  const email=document.getElementById('email-input')?.value?.trim();
  const pass=document.getElementById('password-input')?.value?.trim();
  if (!email || !pass) { alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
  try {
    await loginWithEmail(email, pass);
    document.getElementById('auth-modal')?.remove();
  } catch(e) { alert(e.message); }
}
async function handleEmailRegisterForm() {
  const name=prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); if (!name) return;
  const username=(name||'').toLowerCase().replace(/\s+/g,'_');
  const email=prompt('Email'); if (!email) return;
  const pass=prompt('–ü–∞—Ä–æ–ª—å'); if (!pass) return;
  try {
    await registerWithEmail(name, username, email, pass);
    document.getElementById('auth-modal')?.remove();
  } catch(e) { alert(e.message); }
}
async function showGitHubAuth() {
  const provider=new firebase.auth.GithubAuthProvider();
  try {
    const result=await auth.signInWithPopup(provider);
    currentUser=result.user;
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –µ—Å–ª–∏ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
    await ensureUserProfile();
    await initAfterLogin();
    document.getElementById('auth-modal')?.remove();
  } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}
async function sendPhoneOtp() {
  const phone=document.getElementById('phone-input')?.value?.trim();
  if (!phone) { alert('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä'); return; }
  let phoneNumber=phone;
  if (!phoneNumber.startsWith('+')) {
    phoneNumber='+7'+phoneNumber.replace(/^[0-9]*/,'');
  }
  const ok=await sendOtpForPhone(phoneNumber);
  if (ok) {
    document.getElementById('auth-content').innerHTML=`
      <input id="otp-input" placeholder="–ö–æ–¥ –∏–∑ SMS" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
      <button onclick="verifyPhoneOtp()" style="width:100%; padding:8px; border:none; border-radius:6px; background:#28a745; color:#fff;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    `;
  }
}
async function verifyPhoneOtp() {
  const code=document.getElementById('otp-input')?.value?.trim();
  if (!code) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥'); return; }
  try {
    const user=await verifyOtp(code);
    if (user) {
      await ensureUserProfile();
      document.getElementById('auth-modal')?.remove();
    }
  } catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message); }
}

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
async function initAfterLogin() {
  await loadUserProfile();
  await loadChats();
  const lastId=localStorage.getItem('lastChatId');
  if (lastId) await openChat(lastId);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
async function loadUserProfile() {
  if (!currentUser) return;
  const doc=await db.collection('users').doc(currentUser.uid).get();
  if (doc.exists) {
    const data=doc.data();
    document.getElementById('profile-name-sidebar').textContent=data.name||'';
    document.getElementById('profile-status-sidebar').textContent=data.status||'';
    if (data.avatarUrl) {
      document.getElementById('profile-avatar').style.backgroundImage=`url(${data.avatarUrl})`;
      document.getElementById('profile-avatar').textContent='';
    } else {
      document.getElementById('profile-avatar').style.backgroundImage='';
      document.getElementById('profile-avatar').textContent='üòä';
    }
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
async function loadChats() {
  if (chatsUnsub) chatsUnsub();
  if (!currentUser) return;
  chatsUnsub= db.collection('chats')
    .where('members','array-contains', currentUser.uid)
    .orderBy('updatedAt','desc')
    .onSnapshot(snapshot => {
      const container=document.getElementById('chats');
      container.innerHTML='';
      snapshot.forEach(doc => {
        const chat=doc.data();
        const el=document.createElement('div');
        el.className='chat-item';
        el.id='chat-'+doc.id;
        el.onclick=()=>{ openChat(doc.id); };
        if (currentChatId===doc.id) el.classList.add('active');
        const avatar=document.createElement('div');
        avatar.className='avatar';
        avatar.textContent=(chat.name?.charAt(0)||'–ß').toUpperCase();
        if (chat.avatarUrl) {
          avatar.style.backgroundImage=`url(${chat.avatarUrl})`;
          avatar.style.backgroundSize='cover'; avatar.style.backgroundPosition='center'; avatar.textContent='';
        }
        const info=document.createElement('div');
        info.className='chat-info';
        info.innerHTML=`<div class="chat-name">${chat.name||'–ß–∞—Ç'}</div><div class="chat-last-message">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${chat.members?.length||0}</div>`;
        el.appendChild(avatar);
        el.appendChild(info);
        container.appendChild(el);
      });
    });
}

// –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
async function openChat(chatId) {
  currentChatId=chatId;
  localStorage.setItem('lastChatId', chatId);
  document.querySelectorAll('.chat-item').forEach(e=>e.classList.remove('active'));
  const el=document.getElementById('chat-'+chatId);
  if (el) el.classList.add('active');

  const chatRef=db.collection('chats').doc(chatId);
  const chatDoc=await chatRef.get();
  if (!chatDoc.exists) return;
  const chatData=chatDoc.data();
  document.getElementById('chat-title').textContent='–ß–∞—Ç: '+(chatData.name||'–ß–∞—Ç');
  document.getElementById('chat-status').textContent='';
  if (messagesUnsub) messagesUnsub();
  messagesUnsub= chatRef.collection('messages')
    .orderBy('createdAt','asc')
    .onSnapshot(snap => {
      const div=document.getElementById('messages');
      div.innerHTML='';
      snap.forEach(doc => {
        const msg=doc.data();
        const msgDiv=document.createElement('div');
        msgDiv.className='message '+(msg.senderId===currentUser.uid?'sent':'recv');
        msgDiv.setAttribute('data-id',doc.id);
        if (msg.replyToId) {
          const reply=document.createElement('div');
          reply.className='reply-preview';
          reply.textContent='–¶–∏—Ç–∞—Ç–∞: '+(msg.replyToText||'');
          msgDiv.appendChild(reply);
        }
        if (msg.text) {
          const t=document.createElement('div');
          t.textContent=decodeText(msg.text);
          msgDiv.appendChild(t);
        }
        if (msg.fileUrl) {
          const a=document.createElement('a');
          a.href=msg.fileUrl;a.target='_blank';a.textContent='–§–∞–π–ª';
          msgDiv.appendChild(a);
        }
        const time=document.createElement('div');
        time.className='time';
        const date=new Date((msg.createdAt?.seconds||Date.now()/1000)*1000);
        time.textContent=date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        msgDiv.appendChild(time);
        div.appendChild(msgDiv);
      });
      div.scrollTop=div.scrollHeight;
    });
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
async function sendMessage() {
  const input=document.getElementById('message-input');
  const text=input.value.trim();
  const fileInput=document.getElementById('file-input');
  if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
  if (!text && fileInput.files.length===0) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª'); return; }
  let fileUrl='';
  if (fileInput.files.length>0) {
    const file=fileInput.files[0];
    const ref=firebase.storage().ref().child('files/'+Date.now()+'_'+file.name);
    await ref.put(file);
    fileUrl=await ref.getDownloadURL();
  }
  const encodedText=text?encodeText(text):null;
  await db.collection('chats').doc(currentChatId).collection('messages').add({
    text:encodedText,
    fileUrl,
    senderId:currentUser.uid,
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    replyToId:replyToMessageId,
    replyToText:replyToMessageId?document.querySelector(`[data-id="${replyToMessageId}"]`)?.textContent||'':null
  });
  document.getElementById('message-input').value='';
  document.getElementById('file-input').value='';
  replyToMessageId=null;
}

// –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
async function createChat() {
  const name=prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞');
  if (!name) return;
  await db.collection('chats').add({
    name,
    members:[currentUser.uid],
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  loadChats();
}

// –í–æ–π—Ç–∏ –∏ –≤—ã–π—Ç–∏
async function logout() {
  await firebase.auth().signOut();
  currentUser=null;
  if (chatsUnsub) chatsUnsub();
  if (messagesUnsub) messagesUnsub();
  document.getElementById('chats').innerHTML='';
  document.getElementById('messages').innerHTML='';
  document.getElementById('chat-title').textContent='–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
  alert('–í—ã –≤—ã—à–ª–∏');
  showLoginModal();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
async function showProfile() {
  document.getElementById('profile-panel').style.display='block';
}
function closeProfile() {
  document.getElementById('profile-panel').style.display='none';
}
async function saveProfile() {
  const name=document.getElementById('profile-name').value.trim();
  const username=document.getElementById('profile-username').value.trim();
  const avatarUrl=document.getElementById('profile-avatar-url').value.trim();
  const status=document.getElementById('profile-status').value.trim();
  if (!currentUser) return;
  await db.collection('users').doc(currentUser.uid).set({ name, username, avatarUrl, status }, { merge: true });
  await loadUserProfile();
  closeProfile();
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
async function openExtendedChat() {
  document.getElementById('extended-chat-creation').style.display='flex';
}
async function createExtendedChat() {
  const name=document.getElementById('ext-chat-name').value.trim();
  const description=document.getElementById('ext-chat-description').value.trim();
  const type=document.querySelector('input[name="chat-type"]:checked')?.value;
  if (!name || !type) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø'); return; }
  let username='';
  if (type==='public') {
    username=prompt('–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π username (5-22 –±—É–∫–≤—ã, —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ)');
    if (!/^[A-Za-z]{1}[A-Za-z_\-/]{4,21}$/.test(username)) { alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç username'); return; }
    const snap=await db.collection('chats').where('username','==',username).get();
    if (!snap.empty) { alert('–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç'); return; }
  }
  const color=groupColors[Math.floor(Math.random()*groupColors.length)];
  const groupData={
    name,
    description,
    type,
    members:[currentUser.uid],
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    bgColor:color,
    iconLetter: name.charAt(0).toUpperCase()
  };
  if (type==='public') groupData.username=username;
  const ref=await db.collection('chats').add(groupData);
  alert('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
  await openChat(ref.id);
  closeExtendedChat();
}
function closeExtendedChat() { document.getElementById('extended-chat-creation').style.display='none'; }

// –í—Ö–æ–¥ –∏ –≤—ã—Ö–æ–¥
async function loginWithGitHub() {
  const provider=new firebase.auth.GithubAuthProvider();
  try {
    const result=await auth.signInWithPopup(provider);
    currentUser=result.user;
    await ensureUserProfile();
    await initAfterLogin();
  } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function initAfterLogin() {
  await loadUserProfile();
  await loadChats();
  const lastId=localStorage.getItem('lastChatId');
  if (lastId) await openChat(lastId);
}

// –í—Ö–æ–¥ —á–µ—Ä–µ–∑ email
async function loginWithEmail(email, pass) {
  await auth.signInWithEmailAndPassword(email, pass);
}
async function registerWithEmail(name, username, email, pass) {
  const cred=await auth.createUserWithEmailAndPassword(email, pass);
  await db.collection('users').doc(cred.user.uid).set({
    name, username, email, status:'–û–Ω–ª–∞–π–Ω', avatarUrl:'', initials: name.charAt(0).toUpperCase()
  });
  return cred.user;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –¥–ª—è phone
function setupRecaptcha() {
  window.recaptchaVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'invisible'});
  window.recaptchaVerifier.render();
}
async function sendOtpForPhone(phoneNumber) {
  if (!window.recaptchaVerifier) setupRecaptcha();
  try {
    confirmationResult=await firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
    phoneAuthInProgress=true;
    alert('SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.');
    return true;
  } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); return false; }
}
async function verifyOtp(code) {
  if (!confirmationResult) { alert('–ù–µ—Ç –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'); return null; }
  try {
    const result=await confirmationResult.confirm(code);
    return result.user;
  } catch(e){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: '+e.message); return null; }
}

// –í—ã–π—Ç–∏
async function logout() {
  await firebase.auth().signOut();
  currentUser=null;
  if (chatsUnsub) chatsUnsub();
  if (messagesUnsub) messagesUnsub();
  document.getElementById('chats').innerHTML='';
  document.getElementById('messages').innerHTML='';
  document.getElementById('chat-title').textContent='–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
  alert('–í—ã –≤—ã—à–ª–∏');
  showLoginModal();
}

// –í—ã–∑–æ–≤ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
window.onload=()=> {
  if (firebase.auth().currentUser) {
    currentUser=firebase.auth().currentUser;
    initAfterLogin();
  } else {
    showLoginModal();
  }
};
</script>
<div id="recaptcha-container"></div>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Proar Glass Messenger</title>
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 
      ========================================
      ДЛЯ GITHUB: ЭТО ФАЙЛ STYLE.CSS
      Скопируйте содержимое тега <style> ниже
      в отдельный файл style.css
      ========================================
    -->
    <style>
        /* --- STYLE.CSS BEGIN --- */
        :root {
            /* Enhanced Dark Glass Theme */
            --bg-dark: #0a0a0f;
            --bg-darker: #050508;
            --glass-base: rgba(20, 20, 30, 0.7);
            --glass-light: rgba(40, 40, 60, 0.5);
            --glass-border: rgba(255, 255, 255, 0.06);
            --glass-highlight: rgba(255, 255, 255, 0.04);
            --accent: #6366f1;
            --accent-bright: #818cf8;
            --accent-grad: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --msg-out: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%);
            --msg-in: rgba(255, 255, 255, 0.06);
            
            --blur: 24px;
            --radius-xl: 28px;
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* --- RESET & BASE --- */
        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh; 
            overflow: hidden;
            display: flex; 
            align-items: center; 
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- ENHANCED ANIMATED BACKGROUND --- */
        .ambient-bg {
            position: fixed; 
            inset: 0; 
            z-index: -1; 
            overflow: hidden;
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        var(--bg-dark);
        }
        
        .blob {
            position: absolute; 
            border-radius: 50%; 
            filter: blur(80px); 
            opacity: 0.3;
            animation: float 15s infinite ease-in-out;
            will-change: transform;
        }
        .blob-1 { 
            top: -15%; 
            left: -10%; 
            width: 600px; 
            height: 600px; 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            animation-delay: 0s; 
        }
        .blob-2 { 
            bottom: -15%; 
            right: -10%; 
            width: 500px; 
            height: 500px; 
            background: linear-gradient(135deg, #ec4899, #8b5cf6); 
            animation-delay: -5s; 
        }
        .blob-3 { 
            top: 50%; 
            left: 50%; 
            width: 400px; 
            height: 400px; 
            background: linear-gradient(135deg, #3b82f6, #06b6d4); 
            animation-delay: -10s; 
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(50px, -50px) rotate(120deg); }
            66% { transform: translate(-30px, 40px) rotate(240deg); }
        }

        /* --- LAYOUT UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        .w-full { width: 100%; }
        .scroll-y { overflow-y: auto; }

        /* Enhanced Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: rgba(255, 255, 255, 0.08); 
            border-radius: 10px; 
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.15); background-clip: padding-box; }

        /* --- GLASS COMPONENTS --- */
        .glass-panel {
            background: var(--glass-base);
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
        }

        .btn {
            padding: 12px 24px; 
            border: none; 
            border-radius: var(--radius-sm);
            cursor: pointer; 
            font-weight: 600; 
            font-size: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            font-family: inherit;
            user-select: none;
        }
        .btn-primary {
            background: var(--accent-grad); 
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5); 
        }
        .btn-primary:active { transform: translateY(0); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-ghost { 
            background: transparent; 
            color: var(--text-secondary); 
            border: 1px solid transparent;
        }
        .btn-ghost:hover { 
            background: var(--glass-highlight); 
            color: var(--text-primary);
            border-color: var(--glass-border);
        }

        .input-glass {
            background: rgba(0, 0, 0, 0.25); 
            border: 1px solid var(--glass-border);
            color: white; 
            padding: 14px 16px; 
            border-radius: var(--radius-sm); 
            width: 100%;
            transition: all 0.25s; 
            font-size: 15px;
            font-family: inherit;
        }
        .input-glass::placeholder {
            color: var(--text-muted);
        }
        .input-glass:focus { 
            border-color: var(--accent); 
            background: rgba(0, 0, 0, 0.35);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* --- AUTH SCREEN --- */
        #auth-container {
            position: fixed; 
            inset: 0; 
            z-index: 5000;
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            width: 100%; 
            max-width: 420px; 
            padding: 48px 40px;
            border-radius: var(--radius-xl); 
            text-align: center;
            animation: authSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes authSlideIn { 
            from { 
                transform: scale(0.9) translateY(20px); 
                opacity: 0; 
            } 
            to { 
                transform: scale(1) translateY(0); 
                opacity: 1; 
            } 
        }

        .logo-glow {
            font-size: 56px; 
            margin-bottom: 24px; 
            background: var(--accent-grad); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px rgba(99, 102, 241, 0.6));
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 15px;
        }

        .form-group {
            text-align: left;
            margin-bottom: 16px;
        }

        .form-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: 4px;
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }

        /* --- MAIN APP LAYOUT --- */
        #app-container {
            width: 96vw; 
            height: 92vh; 
            max-width: 1500px;
            max-height: 900px;
            display: flex; 
            border-radius: var(--radius-xl);
            overflow: hidden; 
            opacity: 0; 
            transform: scale(0.95);
            transition: opacity 0.6s, transform 0.6s;
        }
        #app-container.loaded { 
            opacity: 1; 
            transform: scale(1); 
        }

        /* SIDEBAR */
        aside {
            width: 400px; 
            display: flex; 
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
            flex-shrink: 0; 
            position: relative; 
            z-index: 10;
            background: rgba(10, 10, 15, 0.5);
        }
        
        .sidebar-header {
            padding: 24px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .user-mini-profile {
            display: flex; 
            align-items: center; 
            gap: 12px; 
            cursor: pointer;
            padding: 8px 12px; 
            border-radius: var(--radius-md); 
            transition: all 0.2s;
            flex: 1;
            min-width: 0;
        }
        .user-mini-profile:hover { 
            background: var(--glass-highlight); 
        }

        .prc-badge {
            font-size: 12px; 
            color: #fbbf24; 
            font-weight: 700; 
            background: rgba(251, 191, 36, 0.1); 
            padding: 2px 8px; 
            border-radius: 12px; 
            border: 1px solid rgba(251, 191, 36, 0.2);
            margin-top: 4px;
            display: inline-block;
        }

        .search-wrapper { 
            padding: 0 20px 16px; 
        }
        .search-box {
            position: relative;
        }
        .search-box i { 
            position: absolute; 
            left: 16px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-muted);
            font-size: 14px;
        }
        .search-box input { 
            padding-left: 44px; 
            border-radius: var(--radius-lg); 
            background: rgba(0, 0, 0, 0.25); 
            border: 1px solid var(--glass-border);
            font-size: 14px;
        }

        .tabs {
            display: flex; 
            padding: 12px 20px; 
            gap: 8px; 
            border-bottom: 1px solid var(--glass-border);
        }
        .tab-btn {
            flex: 1; 
            padding: 10px 12px; 
            border-radius: var(--radius-sm); 
            text-align: center;
            font-size: 13px; 
            color: var(--text-secondary); 
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            border: 1px solid transparent;
        }
        .tab-btn:hover {
            background: var(--glass-highlight);
            color: var(--text-primary);
        }
        .tab-btn.active { 
            background: var(--accent-grad);
            color: white; 
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
        }

        .chat-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 8px; 
        }
        
        .chat-item {
            display: flex; 
            align-items: center; 
            padding: 14px 12px;
            border-radius: var(--radius-md); 
            cursor: pointer;
            margin-bottom: 4px; 
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .chat-item:hover { 
            background: var(--glass-highlight);
            border-color: var(--glass-border);
        }
        .chat-item.active { 
            background: var(--accent-grad);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
            border-color: transparent;
        }
        
        .avatar {
            width: 48px; 
            height: 48px; 
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-weight: 700; 
            font-size: 18px; 
            color: white;
            margin-right: 12px; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        .avatar img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .online-dot {
            position: absolute; 
            bottom: 0; 
            right: 0; 
            width: 14px; 
            height: 14px;
            background: var(--success); 
            border-radius: 50%; 
            border: 3px solid var(--bg-dark);
            box-shadow: 0 0 8px var(--success);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 13px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item.active .chat-preview {
            color: rgba(255, 255, 255, 0.8);
        }

        /* MAIN CHAT AREA */
        main {
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            background: rgba(0, 0, 0, 0.15);
        }

        .chat-header {
            padding: 20px 28px; 
            border-bottom: 1px solid var(--glass-border);
            background: rgba(20, 20, 30, 0.4); 
            backdrop-filter: blur(20px);
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            z-index: 5;
        }
        
        .messages-area {
            flex: 1; 
            padding: 24px 6%; 
            overflow-y: auto;
            display: flex; 
            flex-direction: column; 
            gap: 12px;
        }

        .message {
            max-width: 70%; 
            padding: 12px 16px; 
            border-radius: 18px;
            font-size: 15px; 
            line-height: 1.5; 
            position: relative;
            animation: msgSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        @keyframes msgSlide { 
            from { 
                opacity: 0; 
                transform: translateY(15px) scale(0.9); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }

        .msg-in {
            align-self: flex-start; 
            background: var(--msg-in);
            border-bottom-left-radius: 6px; 
            backdrop-filter: blur(10px);
        }
        .msg-out {
            align-self: flex-end; 
            background: var(--msg-out);
            color: white;
            border-bottom-right-radius: 6px; 
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .msg-sender {
            font-size: 12px;
            color: var(--accent-bright);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .msg-meta {
            font-size: 11px; 
            opacity: 0.7; 
            text-align: right; 
            margin-top: 6px;
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            gap: 5px;
        }

        .chat-input-area {
            padding: 20px 24px; 
            background: rgba(20, 20, 30, 0.4);
            border-top: 1px solid var(--glass-border);
            display: flex; 
            align-items: center; 
            gap: 12px;
        }
        
        .input-message {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .input-message:focus {
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .input-message:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; 
            inset: 0; 
            z-index: 2000;
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(12px);
            display: flex; 
            align-items: center; 
            justify-content: center;
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s;
            padding: 20px;
        }
        .modal-overlay.open { 
            opacity: 1; 
            pointer-events: all; 
        }
        
        .modal-box {
            width: 100%; 
            max-width: 520px; 
            padding: 32px;
            transform: scale(0.9) translateY(20px); 
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.open .modal-box { 
            transform: scale(1) translateY(0); 
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .profile-header {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-bottom: 24px;
        }
        .profile-avatar-xl {
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            border: 4px solid var(--accent);
            margin-bottom: 16px; 
            position: relative; 
            overflow: hidden;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            color: white;
        }
        .profile-avatar-xl img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }

        /* --- VERIFICATION BADGES --- */
        .badge-verified {
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            font-size: 14px;
            animation: badgePulse 2s infinite;
            position: relative;
        }
        
        /* Proar Verification - Purple */
        .badge-verified.proar {
            color: #a78bfa;
            filter: drop-shadow(0 0 8px #a78bfa);
        }
        
        /* KillMods Verification - Blue */
        .badge-verified.killmods {
            color: #22d3ee;
            filter: drop-shadow(0 0 8px #22d3ee);
        }
        
        /* Administration - White */
        .badge-verified.admin {
            color: #ffffff;
            filter: drop-shadow(0 0 8px #ffffff);
        }
        
        /* SET Verification - Gold Star */
        .badge-verified.set {
            color: #fbbf24;
            filter: drop-shadow(0 0 8px #fbbf24);
        }
        
        @keyframes badgePulse { 
            0%, 100% { opacity: 0.9; } 
            50% { opacity: 1; transform: scale(1.05); } 
        }
        
        .verified-tooltip {
            position: absolute; 
            background: rgba(0, 0, 0, 0.95); 
            padding: 6px 12px;
            border-radius: 8px; 
            font-size: 12px; 
            pointer-events: none;
            opacity: 0; 
            transition: all 0.2s; 
            white-space: nowrap; 
            top: -40px; 
            left: 50%; 
            transform: translateX(-50%);
            font-weight: 500;
            z-index: 1000;
        }
        
        .badge-verified.proar .verified-tooltip { border: 1px solid rgba(167, 139, 250, 0.3); }
        .badge-verified.killmods .verified-tooltip { border: 1px solid rgba(34, 211, 238, 0.3); }
        .badge-verified.admin .verified-tooltip { border: 1px solid rgba(255, 255, 255, 0.3); }
        .badge-verified.set .verified-tooltip { border: 1px solid rgba(251, 191, 36, 0.3); }
        
        .badge-wrapper:hover .verified-tooltip { opacity: 1; top: -45px; }
        .badge-wrapper { position: relative; display: inline-block; }

        /* --- GIFTS --- */
        .gift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .gift-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s;
            overflow: hidden;
            aspect-ratio: 0.8;
            cursor: pointer;
        }
        
        .gift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .gift-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));
            z-index: 2;
        }

        .gift-serial {
            position: absolute;
            top: 6px;
            right: 8px;
            font-size: 10px;
            font-weight: 800;
            color: rgba(255,255,255,0.6);
            z-index: 3;
            background: rgba(0,0,0,0.5);
            padding: 2px 6px;
            border-radius: 8px;
        }

        .gift-btn-paint {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 8px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            text-align: center;
            opacity: 0;
            transition: 0.3s;
            z-index: 4;
        }

        .gift-card:hover .gift-btn-paint {
            opacity: 1;
        }

        .paint-btn-inner {
            background: var(--accent-grad);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .gift-shop-banner {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.2);
        }

        /* --- PAINT ANIMATION --- */
        .paint-loader {
            width: 150px;
            height: 150px;
            position: relative;
            margin: 0 auto 20px;
        }
        .paint-loader::before, .paint-loader::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 5px solid transparent;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }
        .paint-loader::after {
            border-top-color: #ec4899;
            animation: spin 1.5s linear infinite reverse;
            inset: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- FAB & MOBILE --- */
        .fab {
            position: absolute; 
            bottom: 24px; 
            right: 24px;
            width: 64px; 
            height: 64px; 
            border-radius: 50%;
            background: var(--accent-grad);
            color: white;
            font-size: 24px; 
            border: none; 
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5);
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 100;
        }
        .fab:hover { 
            transform: rotate(90deg) scale(1.1); 
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.6);
        }

        .back-btn { 
            display: none; 
            margin-right: 16px; 
            background: none; 
            border: none; 
            color: white; 
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .back-btn:hover {
            background: var(--glass-highlight);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 72px;
            margin-bottom: 24px;
            opacity: 0.4;
            background: var(--accent-grad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .empty-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Channel Badge */
        .channel-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.4);
            border-radius: 50%;
            font-size: 10px;
            color: var(--accent-bright);
            margin-left: 4px;
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            #app-container { 
                width: 100%; 
                height: 100%; 
                border-radius: 0;
                max-height: none;
            }
            aside { 
                width: 100%; 
                position: absolute; 
                height: 100%; 
                background: var(--bg-dark); 
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 100;
            }
            aside.hidden { 
                transform: translateX(-100%); 
            }
            .back-btn { 
                display: flex; 
            }
            .messages-area {
                padding: 20px 16px;
            }
            .message {
                max-width: 85%;
            }
            .tabs {
                overflow-x: auto;
                padding: 12px 16px;
            }
            .tab-btn {
                white-space: nowrap;
                min-width: 80px;
            }
        }

        @media (max-width: 480px) {
            .auth-card {
                padding: 32px 24px;
            }
            .fab {
                bottom: 16px;
                right: 16px;
                width: 56px;
                height: 56px;
            }
            aside {
                width: 100%;
            }
            .sidebar-header {
                padding: 20px 16px;
            }
            .search-wrapper {
                padding: 0 16px 12px;
            }
        }

        .profile-tabs {
            display: flex;
            margin-bottom: 16px;
            background: rgba(0,0,0,0.2);
            padding: 4px;
            border-radius: 12px;
        }
        .p-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            color: var(--text-secondary);
        }
        .p-tab.active {
            background: var(--glass-highlight);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* --- STYLE.CSS END --- */
    </style>
</head>
<body>

    <!-- Background Elements -->
    <div class="ambient-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-container">
        <!-- LOGIN -->
        <div id="login-form" class="auth-card glass-panel">
            <div class="logo-glow"><i class="fab fa-telegram-plane"></i></div>
            <h2 class="auth-title">Добро пожаловать</h2>
            <p class="auth-subtitle">Войдите в Proar Glass Messenger</p>
            
            <div class="form-group">
                <label class="form-label">Email адрес</label>
                <input type="email" id="l-email" class="input-glass" placeholder="user@example.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Пароль</label>
                <input type="password" id="l-pass" class="input-glass" placeholder="••••••••">
            </div>

            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; justify-content: center;">
                <input type="checkbox" id="l-incognito" style="width: 18px; height: 18px; cursor: pointer;">
                <label for="l-incognito" style="font-size: 14px; color: var(--text-secondary); cursor: pointer;">
                    Режим инкогнито <i class="fas fa-user-secret" style="color: #a78bfa;"></i>
                </label>
            </div>

            <button class="btn btn-primary w-full" onclick="login()">
                <i class="fas fa-sign-in-alt"></i>
                Войти
            </button>
            <button class="btn btn-ghost w-full" style="margin-top: 12px;" onclick="toggleAuth('reg')">
                Создать аккаунт
            </button>
        </div>

        <!-- REGISTER -->
        <div id="reg-form" class="auth-card glass-panel hidden">
            <div class="logo-glow"><i class="fas fa-user-astronaut"></i></div>
            <h2 class="auth-title">Регистрация</h2>
            <p class="auth-subtitle">Создайте свой аккаунт</p>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="r-email" class="input-glass" placeholder="user@example.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Пароль</label>
                <input type="password" id="r-pass" class="input-glass" placeholder="Минимум 6 символов">
            </div>
            
            <div class="form-group">
                <label class="form-label">Имя</label>
                <input type="text" id="r-name" class="input-glass" placeholder="Как вас зовут?">
            </div>
            
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="r-username" class="input-glass" placeholder="username">
            </div>

            <button class="btn btn-primary w-full" onclick="register()" style="margin-top: 8px;">
                <i class="fas fa-user-plus"></i>
                Создать аккаунт
            </button>
            <button class="btn btn-ghost w-full" style="margin-top: 12px;" onclick="toggleAuth('login')">
                Уже есть аккаунт
            </button>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="glass-panel hidden">
        
        <!-- SIDEBAR -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="user-mini-profile" onclick="openProfileModal()">
                    <div class="avatar" style="width: 40px; height: 40px; font-size: 16px;" id="mini-avatar">?</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="mini-name">Загрузка...</div>
                        <div id="mini-balance" class="prc-badge">0 PRC</div>
                        <div id="incognito-indicator" class="hidden" style="font-size: 11px; color: #a78bfa; margin-top: 2px;">
                            <i class="fas fa-user-secret"></i> Инкогнито
                        </div>
                    </div>
                </div>
                <button class="btn btn-ghost" onclick="logout()" title="Выйти" style="padding: 10px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>

            <div class="search-wrapper">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" class="input-glass" placeholder="Поиск...">
                </div>
            </div>

            <div class="tabs">
                <div class="tab-btn active" onclick="setFilter('all')">Все</div>
                <div class="tab-btn" onclick="setFilter('private')">Личные</div>
                <div class="tab-btn" onclick="setFilter('group')">Группы</div>
                <div class="tab-btn" onclick="setFilter('channel')">Каналы</div>
            </div>

            <!-- Global Search Results -->
            <div id="global-search-results" class="chat-list hidden" style="border-bottom: 1px solid var(--glass-border); max-height: 280px;">
                <div style="padding: 12px 16px; font-size: 12px; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                    Результаты поиска
                </div>
                <div id="gs-content"></div>
            </div>

            <!-- Chat List -->
            <div id="chat-list" class="chat-list">
                <!-- Chats go here -->
            </div>

            <button class="fab" onclick="openCreateModal()" title="Создать">
                <i class="fas fa-plus"></i>
            </button>
        </aside>

        <!-- MAIN CHAT -->
        <main>
            <!-- Welcome State -->
            <div id="empty-state" class="empty-state">
                <div class="empty-icon"><i class="fab fa-telegram-plane"></i></div>
                <h3 class="empty-title">Proar Glass Messenger</h3>
                <p class="empty-subtitle">Выберите чат для начала общения</p>
            </div>

            <!-- Chat Interface -->
            <div id="chat-interface" class="flex flex-col w-full hidden" style="height: 100%;">
                <header class="chat-header">
                    <div class="flex-center">
                        <button class="back-btn" onclick="closeChatMobile()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="avatar" id="header-avatar" style="width: 44px; height: 44px; font-size: 18px;"></div>
                        <div>
                            <div class="chat-name" id="header-name" style="font-size: 16px;">Имя</div>
                            <div style="font-size: 13px; color: var(--accent); font-weight: 500;" id="header-status">онлайн</div>
                        </div>
                    </div>
                    <button class="btn btn-ghost" style="padding: 10px;">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </header>

                <div id="messages-container" class="messages-area"></div>

                <div class="chat-input-area">
                    <button class="btn btn-ghost" style="padding: 12px;" title="Прикрепить файл">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="text" id="msg-input" class="input-message" placeholder="Сообщение..." autocomplete="off">
                    <button class="btn btn-primary send-btn" onclick="sendMessage()" title="Отправить">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <div class="modal-header">
                <h3 class="modal-title">Профиль</h3>
                <button class="btn btn-ghost" onclick="closeModal('profile-modal')" style="padding: 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="profile-tabs">
                <!-- Added IDs for JS selection -->
                <div id="tab-btn-info" class="p-tab active" onclick="switchProfileTab('info')">Информация</div>
                <div id="tab-btn-gifts" class="p-tab" onclick="switchProfileTab('gifts')">Подарки</div>
            </div>
            
            <div id="p-tab-info">
                <div class="profile-header">
                    <div class="profile-avatar-xl" id="profile-preview-img"></div>
                    <div id="profile-badge-container" style="margin-bottom: 8px;"></div>
                    <div class="prc-badge" id="profile-balance" style="font-size: 14px; padding: 4px 12px;">0 PRC</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Отображаемое имя</label>
                    <input id="p-name" class="input-glass">
                </div>

                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input id="p-username" class="input-glass" placeholder="username">
                </div>

                <div class="form-group">
                    <label class="form-label">О себе</label>
                    <input id="p-bio" class="input-glass" placeholder="Расскажите о себе">
                </div>

                <div class="form-group">
                    <label class="form-label">Фото профиля (URL)</label>
                    <input id="p-photo" class="input-glass" placeholder="https://...">
                </div>

                <button class="btn btn-primary w-full" onclick="saveProfile()" style="margin-top: 8px;">
                    <i class="fas fa-save"></i>
                    Сохранить
                </button>
            </div>

            <div id="p-tab-gifts" class="hidden">
                <div class="gift-shop-banner">
                    <div>
                        <div style="font-weight: 800; font-size: 18px;">Gift Cube</div>
                        <div style="font-size: 12px; opacity: 0.8;">Лимитированная серия</div>
                        <div style="font-size: 11px; margin-top: 4px;">Осталось: <span id="gift-global-count">...</span> / 10000</div>
                    </div>
                    <button class="btn btn-primary" style="background: white; color: black;" onclick="buyGift()">
                        1000 PRC
                    </button>
                </div>
                
                <h4 style="margin-bottom: 12px; font-size: 14px; color: var(--text-secondary);">Моя коллекция</h4>
                <div id="gift-collection" class="gift-grid">
                    <!-- Gifts rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Paint Animation Modal -->
    <div id="paint-modal" class="modal-overlay" style="z-index: 2200;">
        <div class="modal-box glass-panel" style="text-align: center;">
            <h3 class="modal-title" style="margin-bottom: 32px;">Раскрашиваем...</h3>
            <div class="paint-loader"></div>
            <p style="color: var(--text-muted);">Магия происходит ✨</p>
        </div>
    </div>

    <!-- Create Selection Modal -->
    <div id="create-selection-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <div class="modal-header">
                <h3 class="modal-title">Создать</h3>
                <button class="btn btn-ghost" onclick="closeModal('create-selection-modal')" style="padding: 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <button class="btn btn-primary w-full" onclick="openCreateGroupModal()" style="margin-bottom: 12px;">
                <i class="fas fa-users"></i>
                Создать группу
            </button>

            <button class="btn btn-primary w-full" onclick="openCreateChannelModal()">
                <i class="fas fa-bullhorn"></i>
                Создать канал
            </button>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="group-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <div class="modal-header">
                <h3 class="modal-title">Новая группа</h3>
                <button class="btn btn-ghost" onclick="closeModal('group-modal')" style="padding: 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Название группы</label>
                <input id="g-name" class="input-glass" placeholder="Моя группа">
            </div>
            
            <div class="form-group">
                <label class="form-label">Участники</label>
                <textarea id="g-members" class="input-glass" placeholder="username1, username2, username3" rows="3" style="resize: vertical;"></textarea>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">
                    Введите username через запятую
                </div>
            </div>
            
            <button class="btn btn-primary w-full" onclick="createGroup()" style="margin-top: 8px;">
                <i class="fas fa-users"></i>
                Создать группу
            </button>
        </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="channel-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <div class="modal-header">
                <h3 class="modal-title">Новый канал</h3>
                <button class="btn btn-ghost" onclick="closeModal('channel-modal')" style="padding: 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Название канала</label>
                <input id="c-name" class="input-glass" placeholder="Мой канал">
            </div>

            <div class="form-group">
                <label class="form-label">Username канала</label>
                <input id="c-username" class="input-glass" placeholder="mychannel">
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">
                    Пользователи смогут найти ваш канал по этому username
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Описание</label>
                <textarea id="c-description" class="input-glass" placeholder="О чём ваш канал?" rows="3" style="resize: vertical;"></textarea>
            </div>
            
            <button class="btn btn-primary w-full" onclick="createChannel()" style="margin-top: 8px;">
                <i class="fas fa-bullhorn"></i>
                Создать канал
            </button>
        </div>
    </div>

    <!-- 
      ========================================
      ДЛЯ GITHUB: ЭТО ФАЙЛ SCRIPT.JS
      Скопируйте содержимое тега <script type="module"> ниже
      в отдельный файл script.js
      ========================================
    -->
    <script type="module">
        /* --- SCRIPT.JS BEGIN --- */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, doc, updateDoc, getDocs, setDoc, getDoc, limit, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyB-R3yavvxAaMeJ6bi_RneFuMkrqmHyE5g",
          authDomain: "proar-3cf77.firebaseapp.com",
          projectId: "proar-3cf77",
          storageBucket: "proar-3cf77.firebasestorage.app",
          messagingSenderId: "676918837096",
          appId: "1:676918837096:web:c7dbd6f8e44fcf230f60dd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'proar-glass-v4';

        // ===== GIFT ASSETS CONFIG =====
        const BASE_REPO_URL = "https://github.com/KILLMODS/Proar/blob/main/";
        
        const GIFTS = {
            base: "gift.png?raw=true",
            pool: [
                "3d_gift.png?raw=true", "atombutton_gift.png?raw=true", "bitcoin_gift.png?raw=true", 
                "cube_gift.png?raw=true", "derevo_gift.png?raw=true", "error-gift.png?raw=true", 
                "global_gift.png?raw=true", "mc_gift.png?raw=true", "notcoin_gift.png?raw=true", 
                "palitra_gift.png?raw=true", "pepe_gift.png?raw=true", "ph_gift.png?raw=true", 
                "pi_gift.png?raw=true", "prc_gift.png?raw=true", "rkn_gift.png?raw=true", 
                "russia_gift.png?raw=true", "telegram_gift.png?raw=true"
            ]
        };

        const BACKGROUND_WEIGHTS = [
            { id: 'black', color: '#111111', weight: 3 },
            { id: 'dark-gray', color: '#333333', weight: 4 },
            { id: 'gray', color: '#666666', weight: 8 },
            { id: 'light-gray', color: '#999999', weight: 10 },
            { id: 'red', color: '#ef4444', weight: 32 },
            { id: 'pink', color: '#ec4899', weight: 12 },
            { id: 'blue', color: '#2563eb', weight: 36 },
            { id: 'light-blue', color: '#38bdf8', weight: 40 },
            { id: 'purple', color: '#9333ea', weight: 13 },
            { id: 'brown', color: '#78350f', weight: 38 },
            { id: 'yellow', color: '#fbbf24', weight: 47 },
            { id: 'orange', color: '#f97316', weight: 40 },
            { id: 'chameleon', color: 'linear-gradient(45deg, #ff0000, #00ff00, #0000ff)', weight: 0.8 }
        ];

        // ===== VERIFICATION CONFIG =====
        const VERIFIED_USERS = {
            'admi@gmail.com': 'proar',
            'developer@proar.com': 'proar',
            'admin@gmail.com': 'killmods',
            'administrator@proar.com': 'admin',
            'set@example.com': 'set',
        };

        const VERIFICATION_LABELS = {
            'proar': 'Verified for Proar',
            'killmods': 'Verified for @killmods',
            'admin': 'Administration',
            'set': 'Verified @SET'
        };

        // STATE
        let currentUser = null;
        let currentChatId = null;
        let currentChatType = null;
        let allChats = [];
        let chatListener = null;
        let msgListener = null;
        let filterType = 'all';
        let isIncognitoMode = false;

        // --- AUTH FUNCTIONS ---
        window.toggleAuth = (mode) => {
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
            document.getElementById('reg-form').classList.toggle('hidden', mode !== 'reg');
        };

        window.login = async () => {
            const email = document.getElementById('l-email').value.trim();
            const pass = document.getElementById('l-pass').value;
            isIncognitoMode = document.getElementById('l-incognito').checked;
            
            if (!email || !pass) {
                alert("Заполните все поля!");
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { 
                alert("Ошибка входа: " + e.message); 
            }
        };

        window.register = async () => {
            const email = document.getElementById('r-email').value.trim();
            const pass = document.getElementById('r-pass').value;
            const name = document.getElementById('r-name').value.trim();
            let username = document.getElementById('r-username').value.toLowerCase().trim().replace(/^@/, '');

            if (!email || !pass || !name || !username) {
                alert("Заполните все поля!");
                return;
            }
            
            if (pass.length < 6) {
                alert("Пароль должен быть минимум 6 символов!");
                return;
            }

            try {
                const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
                const q = query(usersRef, where('username', '==', username));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    alert("Username уже занят!");
                    return;
                }

                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                const verificationType = VERIFIED_USERS[email] || null;
                
                // Create Profile with 5000 PRC Bonus
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', cred.user.uid), {
                    uid: cred.user.uid,
                    displayName: name,
                    username: username,
                    email: email,
                    photoUrl: '',
                    bio: 'Новый пользователь Proar Glass 🚀',
                    verificationType: verificationType,
                    balance: 5000,
                    createdAt: serverTimestamp()
                });

            } catch (e) { 
                alert("Ошибка регистрации: " + e.message); 
            }
        };

        window.logout = () => {
            if (confirm('Вы уверены, что хотите выйти?')) {
                signOut(auth);
            }
        };

        // --- MAIN APP LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                setTimeout(() => document.getElementById('app-container').classList.add('loaded'), 100);
                
                await ensureUserProfile();
                initChatList();
                updateMiniProfile();
                
                document.getElementById('incognito-indicator').classList.toggle('hidden', !isIncognitoMode);
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('loaded');
                if (chatListener) chatListener();
                if (msgListener) msgListener();
            }
        });

        async function ensureUserProfile() {
            if (!currentUser) return;
            const ref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid);
            try {
                const snap = await getDoc(ref);
                if (!snap.exists()) {
                    await setDoc(ref, {
                        uid: currentUser.uid,
                        displayName: currentUser.displayName || 'Пользователь',
                        username: 'user_' + Math.floor(Math.random() * 100000),
                        email: currentUser.email,
                        photoUrl: '',
                        verificationType: VERIFIED_USERS[currentUser.email] || null,
                        bio: 'Новый пользователь',
                        balance: 0,
                        createdAt: serverTimestamp()
                    });
                } else {
                    if (snap.data().balance === undefined) {
                        await updateDoc(ref, { balance: 0 });
                    }
                }
            } catch (e) {
                console.error("Error ensuring profile:", e);
            }
        }

        async function updateMiniProfile() {
            if (!currentUser) return;
            const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid));
            if (snap.exists()) {
                const data = snap.data();
                const nameEl = document.getElementById('mini-name');
                const balEl = document.getElementById('mini-balance');
                const avEl = document.getElementById('mini-avatar');
                
                if(nameEl) nameEl.innerText = data.displayName;
                if(balEl) balEl.innerText = `${data.balance || 0} PRC`;
                if(avEl) avEl.innerHTML = getAvatarContent(data.displayName, data.photoUrl);
            }
        }

        // --- GIFT LOGIC & FIXED SWITCH TAB ---
        window.switchProfileTab = (tab) => {
            // SAFE IMPLEMENTATION: Do not use event.target
            document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
            
            // Activate specific tab by ID
            const activeBtn = document.getElementById(`tab-btn-${tab}`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Toggle Content
            const infoTab = document.getElementById('p-tab-info');
            const giftsTab = document.getElementById('p-tab-gifts');
            
            if(infoTab) infoTab.classList.toggle('hidden', tab !== 'info');
            if(giftsTab) giftsTab.classList.toggle('hidden', tab !== 'gifts');

            if (tab === 'gifts') {
                loadGifts();
            }
        };

        async function loadGifts() {
            if (!currentUser) return;
            // Update global count
            const statsRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'stats', 'gifts');
            const statsSnap = await getDoc(statsRef);
            const count = statsSnap.exists() ? (statsSnap.data().count || 0) : 0;
            const globalCountEl = document.getElementById('gift-global-count');
            if(globalCountEl) globalCountEl.innerText = 10000 - count;

            // Load user gifts
            const giftsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'gifts');
            const q = query(giftsRef, where('ownerId', '==', currentUser.uid), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            
            const container = document.getElementById('gift-collection');
            if (!container) return;
            container.innerHTML = '';
            
            if (snap.empty) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 20px;">У вас пока нет подарков</div>';
                return;
            }

            snap.forEach(d => {
                const g = d.data();
                const card = document.createElement('div');
                card.className = 'gift-card';
                card.style.background = g.background || 'rgba(255,255,255,0.05)';
                
                const isPainted = g.status === 'painted';
                const paintBtn = !isPainted 
                    ? `<div class="gift-btn-paint">
                        <button class="paint-btn-inner" onclick="paintGift('${d.id}')">Раскрасить</button>
                       </div>` 
                    : '';

                card.innerHTML = `
                    <div class="gift-serial">#${g.serial}</div>
                    <img src="${BASE_REPO_URL}${g.image}" class="gift-image">
                    ${paintBtn}
                `;
                container.appendChild(card);
            });
        }

        window.buyGift = async () => {
            if (!currentUser) return;
            try {
                // 1. Check Balance & Global Limit
                const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid);
                const userSnap = await getDoc(userRef);
                const balance = userSnap.data().balance || 5000;

                if (balance < 1000) {
                    alert("Недостаточно PRC! Стоимость: 1000 PRC");
                    return;
                }

                const statsRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'stats', 'gifts');
                const statsSnap = await getDoc(statsRef);
                let currentCount = statsSnap.exists() ? (statsSnap.data().count || 0) : 0;

                if (currentCount >= 10000) {
                    alert("Все Gift Cubes распроданы!");
                    return;
                }

                // 2. Transaction
                await updateDoc(userRef, { balance: increment(-1000) });
                
                if (!statsSnap.exists()) {
                    await setDoc(statsRef, { count: 1 });
                    currentCount = 0;
                } else {
                    await updateDoc(statsRef, { count: increment(1) });
                }
                
                const serial = currentCount + 1;

                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'gifts'), {
                    ownerId: currentUser.uid,
                    serial: serial,
                    status: 'base',
                    image: 'gift.png?raw=true',
                    background: null,
                    createdAt: serverTimestamp()
                });

                alert(`Успешно куплен Gift Cube #${serial}!`);
                updateMiniProfile();
                const balEl = document.getElementById('profile-balance');
                if(balEl) balEl.innerText = `${balance - 1000} PRC`;
                loadGifts();

            } catch (e) {
                console.error(e);
                alert("Ошибка покупки: " + e.message);
            }
        };

        window.paintGift = async (giftId) => {
            openModal('paint-modal');
            await new Promise(r => setTimeout(r, 5000));
            
            try {
                // Random Logic
                let totalWeight = BACKGROUND_WEIGHTS.reduce((sum, item) => sum + item.weight, 0);
                let randomVal = Math.random() * totalWeight;
                let selectedBg = BACKGROUND_WEIGHTS[0];
                
                for (const item of BACKGROUND_WEIGHTS) {
                    randomVal -= item.weight;
                    if (randomVal <= 0) {
                        selectedBg = item;
                        break;
                    }
                }

                const randomImg = GIFTS.pool[Math.floor(Math.random() * GIFTS.pool.length)];

                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'gifts', giftId), {
                    status: 'painted',
                    background: selectedBg.color,
                    image: randomImg
                });

                closeModal('paint-modal');
                loadGifts(); 

            } catch (e) {
                console.error(e);
                closeModal('paint-modal');
                alert("Ошибка улучшения: " + e.message);
            }
        };

        // --- CHAT LIST & FILTER ---
        function initChatList() {
            if (!currentUser) return;
            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats'), 
                where('members', 'array-contains', currentUser.uid)
            );
            
            chatListener = onSnapshot(q, (snapshot) => {
                allChats = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                allChats.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                renderChats();
            }, (err) => console.error("Chat Listener Error:", err));
        }

        window.setFilter = (type) => {
            filterType = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
            renderChats();
        };

        async function renderChats() {
            const list = document.getElementById('chat-list');
            if(!list) return;
            list.innerHTML = '';
            
            let filtered = allChats;
            if (filterType === 'private') filtered = allChats.filter(c => c.type === 'private');
            if (filterType === 'group') filtered = allChats.filter(c => c.type === 'group');
            if (filterType === 'channel') filtered = allChats.filter(c => c.type === 'channel');

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center; padding:40px 20px; color:var(--text-muted);">
                        <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 14px;">Нет чатов</div>
                    </div>
                `;
                return;
            }

            for (const chat of filtered) {
                const isGroup = chat.type === 'group';
                const isChannel = chat.type === 'channel';
                let title = chat.name;
                let photo = null;
                let verificationType = null;

                if (!isGroup && !isChannel) {
                    const otherId = chat.members.find(id => id !== currentUser.uid) || currentUser.uid;
                    const uDoc = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', otherId));
                    if (uDoc.exists()) {
                        const u = uDoc.data();
                        title = u.displayName;
                        photo = u.photoUrl;
                        verificationType = u.verificationType;
                    } else { 
                        title = "Пользователь"; 
                    }
                }

                const el = document.createElement('div');
                el.className = `chat-item ${currentChatId === chat.id ? 'active' : ''}`;
                el.onclick = () => openChat(chat.id, title, photo, verificationType, chat.type);
                
                el.innerHTML = `
                    <div class="avatar">${getAvatarContent(title, photo)}</div>
                    <div class="chat-info">
                        <div class="flex-between">
                            <div class="chat-name">
                                ${escapeHtml(title)} 
                                ${verificationType ? getVerifiedBadgeHTML(verificationType) : ''}
                                ${isChannel ? '<span class="channel-badge"><i class="fas fa-bullhorn"></i></span>' : ''}
                            </div>
                            <div style="font-size:11px; color: var(--text-muted); flex-shrink: 0; margin-left: 8px;">
                                ${formatTime(chat.updatedAt)}
                            </div>
                        </div>
                        <div class="chat-preview">
                            ${escapeHtml(chat.lastMessage || 'Нет сообщений')}
                        </div>
                    </div>
                `;
                list.appendChild(el);
            }
        }

        // --- SEARCH LOGIC ---
        const searchInput = document.getElementById('search-input');
        const gsContainer = document.getElementById('global-search-results');
        const gsContent = document.getElementById('gs-content');

        let searchTimeout;
        if(searchInput) {
            searchInput.addEventListener('input', async (e) => {
                const val = e.target.value.toLowerCase().trim().replace(/^@/, '');
                
                clearTimeout(searchTimeout);
                
                const items = document.querySelectorAll('#chat-list .chat-item');
                items.forEach(item => {
                    const txt = item.innerText.toLowerCase();
                    item.style.display = txt.includes(val) ? 'flex' : 'none';
                });

                if (val.length >= 2) {
                    gsContainer.classList.remove('hidden');
                    gsContent.innerHTML = '<div style="padding:16px; color:var(--text-muted); font-size: 13px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Поиск...</div>';
                    
                    searchTimeout = setTimeout(async () => {
                        gsContent.innerHTML = '';
                        let foundAny = false;

                        const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
                        const uQuery = query(usersRef, limit(20));
                        const uSnap = await getDocs(uQuery);
                        
                        uSnap.forEach(d => {
                            const u = d.data();
                            if (u.uid !== currentUser.uid &&
                                (u.username?.includes(val) || u.displayName?.toLowerCase().includes(val))) {
                                foundAny = true;
                                const div = document.createElement('div');
                                div.className = 'chat-item';
                                div.innerHTML = `
                                    <div class="avatar">${getAvatarContent(u.displayName, u.photoUrl)}</div>
                                    <div class="chat-info">
                                        <div class="chat-name">
                                            ${escapeHtml(u.displayName)} 
                                            ${u.verificationType ? getVerifiedBadgeHTML(u.verificationType) : ''}
                                        </div>
                                        <div style="font-size:12px; color:var(--accent);">@${escapeHtml(u.username)}</div>
                                    </div>
                                `;
                                div.onclick = () => startPrivateChat(u);
                                gsContent.appendChild(div);
                            }
                        });

                        const channelsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'channels');
                        const cQuery = query(channelsRef, limit(20));
                        const cSnap = await getDocs(cQuery);

                        cSnap.forEach(d => {
                            const ch = d.data();
                            if (ch.username?.includes(val) || ch.name?.toLowerCase().includes(val)) {
                                foundAny = true;
                                const div = document.createElement('div');
                                div.className = 'chat-item';
                                div.innerHTML = `
                                    <div class="avatar">${getAvatarContent(ch.name, ch.photoUrl)}</div>
                                    <div class="chat-info">
                                        <div class="chat-name">
                                            ${escapeHtml(ch.name)}
                                            <span class="channel-badge"><i class="fas fa-bullhorn"></i></span>
                                        </div>
                                        <div style="font-size:12px; color:var(--accent);">@${escapeHtml(ch.username)}</div>
                                    </div>
                                `;
                                div.onclick = () => subscribeToChannel(ch, d.id);
                                gsContent.appendChild(div);
                            }
                        });

                        if (!foundAny) {
                            gsContent.innerHTML = '<div style="padding:16px; color:var(--text-muted); font-size: 13px; text-align: center;">Ничего не найдено</div>';
                        }
                    }, 300);
                } else {
                    gsContainer.classList.add('hidden');
                }
            });
        }

        async function startPrivateChat(targetUser) {
            const uids = [currentUser.uid, targetUser.uid].sort();
            const chatId = `private_${uids[0]}_${uids[1]}`;
            
            const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId);
            const chatSnap = await getDoc(chatRef);

            if (!chatSnap.exists()) {
                await setDoc(chatRef, {
                    type: 'private',
                    members: uids,
                    updatedAt: serverTimestamp(),
                    lastMessage: 'Чат создан'
                });
            }
            
            gsContainer.classList.add('hidden');
            searchInput.value = '';
            
            document.querySelectorAll('#chat-list .chat-item').forEach(item => {
                item.style.display = 'flex';
            });
            
            openChat(chatId, targetUser.displayName, targetUser.photoUrl, targetUser.verificationType, 'private');
        }

        async function subscribeToChannel(channel, channelId) {
            const chatId = `channel_${channelId}_${currentUser.uid}`;
            const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId);
            const chatSnap = await getDoc(chatRef);

            if (!chatSnap.exists()) {
                await setDoc(chatRef, {
                    type: 'channel',
                    channelId: channelId,
                    name: channel.name,
                    members: [currentUser.uid],
                    updatedAt: serverTimestamp(),
                    lastMessage: 'Подписка оформлена'
                });
            }

            gsContainer.classList.add('hidden');
            searchInput.value = '';
            openChat(chatId, channel.name, channel.photoUrl, null, 'channel');
        }

        // --- MESSAGING ---
        window.openChat = (chatId, name, photo, verificationType, type) => {
            currentChatId = chatId;
            currentChatType = type;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            
            if (window.innerWidth <= 900) {
                document.getElementById('sidebar').classList.add('hidden');
            }

            const hName = document.getElementById('header-name');
            if(hName) hName.innerHTML = `${escapeHtml(name)} ${verificationType ? getVerifiedBadgeHTML(verificationType) : ''} ${type === 'channel' ? '<span class="channel-badge"><i class="fas fa-bullhorn"></i></span>' : ''}`;
            const hAv = document.getElementById('header-avatar');
            if(hAv) hAv.innerHTML = getAvatarContent(name, photo);
            
            let statusText = 'онлайн';
            if (type === 'group') statusText = 'группа';
            if (type === 'channel') statusText = 'канал';
            const hStat = document.getElementById('header-status');
            if(hStat) hStat.innerText = statusText;

            const msgInput = document.getElementById('msg-input');
            if(msgInput) {
                if (isIncognitoMode) {
                    msgInput.disabled = true;
                    msgInput.placeholder = 'Режим инкогнито - отправка недоступна';
                } else if (type === 'channel') {
                    msgInput.disabled = true;
                    msgInput.placeholder = 'Только для чтения';
                } else {
                    msgInput.disabled = false;
                    msgInput.placeholder = 'Сообщение...';
                }
            }

            if (msgListener) msgListener();
            const q = query(
                collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId, 'messages'), 
                orderBy('createdAt', 'asc')
            );
            
            msgListener = onSnapshot(q, (snap) => {
                const box = document.getElementById('messages-container');
                if(!box) return;
                box.innerHTML = '';
                
                snap.forEach(d => {
                    const m = d.data();
                    const isMine = m.senderId === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `message ${isMine ? 'msg-out' : 'msg-in'}`;
                    
                    let senderNameHtml = '';
                    if ((type === 'group' || type === 'channel') && !isMine) {
                        senderNameHtml = `<div class="msg-sender">${escapeHtml(m.senderName || 'Пользователь')}</div>`;
                    }
                    
                    div.innerHTML = `
                        ${senderNameHtml}
                        <div>${escapeHtml(m.text)}</div>
                        <div class="msg-meta">
                            ${m.createdAt ? new Date(m.createdAt.seconds*1000).toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}) : '...'}
                            ${isMine ? '<i class="fas fa-check-double" style="color: var(--accent-bright);"></i>' : ''}
                        </div>
                    `;
                    box.appendChild(div);
                });
                
                box.scrollTo({top: box.scrollHeight, behavior: 'smooth'});
            }, (err) => console.error("Msg Listener Error:", err));
        };

        window.sendMessage = async () => {
            if (isIncognitoMode || currentChatType === 'channel') {
                alert(isIncognitoMode ? 'Отправка сообщений в режиме инкогнито недоступна' : 'Вы не можете отправлять сообщения в канал');
                return;
            }

            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if (!txt || !currentChatId) return;
            
            input.value = '';

            try {
                const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                const userSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid));
                const userName = userSnap.exists() ? userSnap.data().displayName : 'Пользователь';
                
                await addDoc(collection(chatRef, 'messages'), {
                    text: txt,
                    senderId: currentUser.uid,
                    senderName: userName,
                    createdAt: serverTimestamp()
                });

                await updateDoc(chatRef, {
                    lastMessage: txt,
                    updatedAt: serverTimestamp()
                });
            } catch (e) {
                console.error("Send message error:", e);
                alert("Ошибка отправки сообщения");
            }
        };

        window.closeChatMobile = () => {
            document.getElementById('sidebar').classList.remove('hidden');
            currentChatId = null;
            currentChatType = null;
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('chat-interface').classList.add('hidden');
            if (msgListener) msgListener();
        };

        // --- PROFILE LOGIC ---
        window.openProfileModal = async () => {
            if (!currentUser) return;
            const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid));
            const u = snap.data();
            
            document.getElementById('p-name').value = u.displayName || '';
            document.getElementById('p-username').value = u.username || '';
            document.getElementById('p-bio').value = u.bio || '';
            document.getElementById('p-photo').value = u.photoUrl || '';
            document.getElementById('profile-balance').innerText = `${u.balance || 0} PRC`;
            
            document.getElementById('profile-preview-img').innerHTML = getAvatarContent(u.displayName, u.photoUrl, true);
            
            const badgeC = document.getElementById('profile-badge-container');
            if (u.verificationType) {
                const label = VERIFICATION_LABELS[u.verificationType] || 'Verified';
                badgeC.innerHTML = `<div style="display:inline-flex; align-items:center; gap:8px; background:rgba(99,102,241,0.1); padding:8px 16px; border-radius:20px; border:1px solid rgba(99,102,241,0.3); font-weight: 600; font-size: 14px;">
                    ${getVerifiedBadgeHTML(u.verificationType)} ${label}
                </div>`;
            } else {
                badgeC.innerHTML = '';
            }

            switchProfileTab('info');
            openModal('profile-modal');
        };

        window.saveProfile = async () => {
            const newName = document.getElementById('p-name').value.trim();
            let newUsername = document.getElementById('p-username').value.toLowerCase().trim().replace(/^@/, '');
            const newBio = document.getElementById('p-bio').value.trim();
            const newPhoto = document.getElementById('p-photo').value.trim();

            if (!newName || !newUsername) {
                alert("Имя и username обязательны!");
                return;
            }

            try {
                const currentSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid));
                const oldUsername = currentSnap.data().username;

                if (newUsername !== oldUsername) {
                    const q = query(
                        collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), 
                        where('username', '==', newUsername)
                    );
                    const snap = await getDocs(q);
                    if (!snap.empty) {
                        alert("Этот username уже занят!");
                        return;
                    }
                }

                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid), {
                    displayName: newName,
                    username: newUsername,
                    bio: newBio,
                    photoUrl: newPhoto
                });

                closeModal('profile-modal');
                updateMiniProfile();
            } catch (e) {
                console.error("Save profile error:", e);
                alert("Ошибка сохранения профиля");
            }
        };

        window.openCreateModal = () => {
            openModal('create-selection-modal');
        };

        window.openCreateGroupModal = () => {
            closeModal('create-selection-modal');
            document.getElementById('g-name').value = '';
            document.getElementById('g-members').value = '';
            openModal('group-modal');
        };
        
        window.createGroup = async () => {
            const name = document.getElementById('g-name').value.trim();
            const userStr = document.getElementById('g-members').value;
            
            if (!name) {
                alert("Введите название группы!");
                return;
            }
            
            const usernames = userStr.split(',').map(s => s.trim().toLowerCase().replace(/^@/, '')).filter(s => s);
            const uids = [currentUser.uid];

            try {
                const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
                for (const uname of usernames) {
                    const snap = await getDocs(query(usersRef, where('username', '==', uname)));
                    if (!snap.empty) uids.push(snap.docs[0].id);
                }

                if (uids.length === 1) {
                    alert("Добавьте хотя бы одного участника!");
                    return;
                }

                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats'), {
                    type: 'group',
                    name: name,
                    members: [...new Set(uids)],
                    updatedAt: serverTimestamp(),
                    lastMessage: 'Группа создана'
                });

                closeModal('group-modal');
            } catch (e) {
                console.error("Create group error:", e);
                alert("Ошибка создания группы");
            }
        };

        window.openCreateChannelModal = () => {
            closeModal('create-selection-modal');
            document.getElementById('c-name').value = '';
            document.getElementById('c-username').value = '';
            document.getElementById('c-description').value = '';
            openModal('channel-modal');
        };

        window.createChannel = async () => {
            const name = document.getElementById('c-name').value.trim();
            let username = document.getElementById('c-username').value.toLowerCase().trim().replace(/^@/, '');
            const description = document.getElementById('c-description').value.trim();

            if (!name || !username) {
                alert("Введите название и username канала!");
                return;
            }

            try {
                const channelsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'channels');
                const q = query(channelsRef, where('username', '==', username));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    alert("Этот username уже занят!");
                    return;
                }

                const channelDoc = await addDoc(channelsRef, {
                    name: name,
                    username: username,
                    description: description,
                    ownerId: currentUser.uid,
                    photoUrl: '',
                    createdAt: serverTimestamp()
                });

                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', `channel_${channelDoc.id}_${currentUser.uid}`), {
                    type: 'channel',
                    channelId: channelDoc.id,
                    name: name,
                    members: [currentUser.uid],
                    updatedAt: serverTimestamp(),
                    lastMessage: 'Канал создан'
                });

                closeModal('channel-modal');
            } catch (e) {
                console.error("Create channel error:", e);
                alert("Ошибка создания канала");
            }
        };

        // --- UTILS ---
        window.openModal = (id) => {
            const el = document.getElementById(id);
            if(el) el.classList.add('open');
        };
        
        window.closeModal = (id) => {
            const el = document.getElementById(id);
            if(el) el.classList.remove('open');
        };
        
        const msgInput = document.getElementById('msg-input');
        if(msgInput) {
            msgInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        const passInput = document.getElementById('l-pass');
        if(passInput) {
            passInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        }

        function getAvatarContent(name, url, isXl = false) {
            if (url) return `<img src="${url}" alt="${escapeHtml(name)}" onerror="this.style.display='none'">`;
            return escapeHtml((name || '?')[0].toUpperCase());
        }

        function getVerifiedBadgeHTML(verificationType) {
            if (!verificationType) return '';
            const label = VERIFICATION_LABELS[verificationType] || 'Verified';
            let icon = '<i class="fas fa-certificate"></i>';
            if (verificationType === 'set') icon = '<i class="fas fa-star"></i>';
            return `<span class="badge-wrapper"><span class="badge-verified ${verificationType}">${icon}</span><div class="verified-tooltip">${label}</div></span>`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(ts) {
            if (!ts || !ts.seconds) return '';
            const d = new Date(ts.seconds * 1000);
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();
            const isYesterday = new Date(now - 86400000).toDateString() === d.toDateString();
            if (isToday) return d.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
            if (isYesterday) return 'Вчера';
            return d.toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'});
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('open');
            });
        });
        /* --- SCRIPT.JS END --- */
    </script>
</body>

</html>

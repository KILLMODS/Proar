<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Proar</title>
<!-- –ò–∫–æ–Ω–∫–∏ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root {
  --bg: linear-gradient(135deg, #1e3c72, #2a5298);
  --header: linear-gradient(135deg, #667eea, #764ba2);
  --sidebar: linear-gradient(135deg, #232526, #1c1c1c);
  --text: #eee;
  --muted: #999;
  --bubble-recv: #3a3a3c;
  --bubble-send: linear-gradient(135deg, #667eea, #764ba2);
  --border: #444;
  --accent: #4caf50;
  --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
  --button-gradient: linear-gradient(135deg, #56ab2f, #a8e063);
}
body {
  margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg); color: var(--text); height: 100vh;
  display: flex; flex-direction: column; transition: background 0.3s, color 0.3s;
}
body.dark {
  --bg: #181818; --header: #222; --sidebar: #222; --text: #eee; --muted: #999;
  --bubble-recv: #3a3a3c; --bubble-send: #0088cc; --border: #444;
}
.header {
  height: 60px; background: var(--header);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; color: #fff; font-weight: 600; position: sticky; top: 0; z-index: 50;
}
.header .title { display: flex; align-items: center; gap: 10px; font-size: 20px; }
#unread-count {
  font-size: 12px; padding: 2px 8px; background: #ef4444; color: #fff; border-radius: 12px; display: none;
}
.header .buttons {
  display: flex; align-items: center;
}
.header .buttons button {
  background: transparent; border: none; color: #fff; margin-left: 10px;
  cursor: pointer; font-size: 18px; padding: 6px 8px; border-radius: 4px;
  transition: background 0.2s, transform 0.2s;
}
.header .buttons button:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }

.container {
  flex: 1; display: flex; overflow: hidden;
}
aside.sidebar {
  width: 4000px; max-width: %; background: var(--sidebar);
  display: flex; flex-direction: column; border-right: 1px solid var(--border);
  transition: transform 0.3s ease; overflow: hidden; position: relative;
}
aside.sidebar.hidden { transform: translateX(-100%); }
.sidebar-header {
  padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--border);
}
#search-panel {
  display: none; padding: 8px 16px;
}
#search-panel.active { display: block; }
#search-input {
  width: 100%; padding: 8px 12px; border-radius: 20px; border: 1px solid #555;
  background: #444; color: #eee; font-size: 14px;
}
#chats {
  flex: 1; overflow-y: auto; padding: 10px;
}
.chat-item {
  display: flex; align-items: center; padding: 10px; cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: background 0.2s, transform 0.2s;
}
.chat-item:hover { background: #2a2a2a; transform: scale(1.02); }
.chat-item.active { background: #3a3a3a; }
.avatar {
  width: 50px; height: 50px; background: #999; border-radius: 50%; display: flex;
  align-items: center; justify-content: center; font-weight: bold; font-size: 20px; color: #fff;
  margin-right: 12px; background-size: cover; background-position: center; flex-shrink: 0;
}
.chat-info { flex: 1; display: flex; flex-direction: column; }
.chat-name {
  font-weight: 600; font-size: 14px; margin-bottom: 4px; display: flex; align-items: center;
}
.dev-badge {
  display: inline-block; width: 16px; height: 16px; margin-left: 6px;
  background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 12px; color: #fff; font-weight: bold; animation: pulse 1s infinite;
}
#new-chat-btn {
  margin: 10px 16px; padding: 10px; background: var(--button-gradient); color: #fff;
  border-radius: 4px; border: none; cursor: pointer; width: calc(100% - 32px);
  font-weight: 600; font-size: 14px; transition: background 0.3s, transform 0.2s;
}
#new-chat-btn:hover { background: linear-gradient(135deg, #43e97b, #38f9d7); transform: scale(1.05); }

section.main {
  flex: 1; display: flex; flex-direction: column; background: #1f1f1f;
}
#chat-header {
  padding: 12px 20px; border-bottom: 1px solid var(--border);
  display:flex; justify-content: space-between; align-items: center;
  background:#222; color:#fff; position:relative;
}
#chat-header > div { display:flex; align-items:center; }
#chat-title { font-weight:600; font-size:16px; display:flex; align-items:center; }
#profile-badge {
  width:16px; height:16px; background:#3b82f6; border-radius:50%; margin-left:6px;
  display:flex; align-items:center; justify-content:center; font-size:10px; color:#fff; font-weight:bold;
  animation: pulse 1s infinite;
}
#logo-text {
  opacity: 0;
  transition: opacity 0.5s ease;
}
#update-text {
  opacity: 1;
  transition: opacity 0.5s ease;
}
#chat-status {
  font-size:12px; color:#888; margin-left:8px;
}
#messages {
  flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;
}
.message {
  max-width:70%; padding:10px 14px; border-radius:20px; margin-bottom:8px; position:relative;
  word-wrap:break-word; font-size:14px; box-shadow:0 1px 3px rgba(0,0,0,0.3);
  transition: all 0.2s;
}
.message.sent { background: var(--bubble-send); align-self: flex-end; color: #fff; }
.message.recv { background: var(--bubble-recv); align-self: flex-start; color: #eee; }
.message .time { font-size:10px; color:#bbb; margin-top:4px; text-align:right; }
.reply-preview {
  font-size:12px; color:#ccc; border-left:3px solid #555; padding-left:8px; margin-bottom:6px;
}
.message img { max-width:260px; border-radius:8px; margin-top:8px; transition:transform 0.2s; }
.message img:hover { transform:scale(1.05); }

#input-area {
  display:flex; padding:8px 16px; border-top:1px solid var(--border);
  background:#222; align-items:center; gap:8px; position:relative;
}
#message-input {
  flex:1; padding:10px 14px; border-radius:20px; border:1px solid #555; background:#444; color:#eee; font-size:14px;
}
#message-input:focus { background:#555; }
#file-label {
  cursor:pointer; font-size:18px; display:flex; align-items:center;
  padding:6px 10px; border-radius:20px; background:#1976d2; color:#fff;
  transition: background 0.2s, transform 0.2s;
}
#file-label:hover { background:#1565c0; transform:scale(1.05); }
#file-input { display:none; }
#send-btn {
  background:#25d366; border:none; padding:8px 14px; border-radius:20px; color:#fff; cursor:pointer; font-size:14px; transition: background 0.2s, transform 0.2s;
}
#send-btn:hover { background:#20b858; transform:scale(1.05); }
button:disabled { opacity:0.6; cursor:not-allowed; }

#voice-recording-indicator {
  position: absolute; bottom:60px; left:calc(50% - 50px);
  width:100px; height:100px; background: radial-gradient(circle, #56ab2f, #a8e063);
  border-radius:50%; display:flex; align-items:center; justify-content:center;
  font-size:14px; color:#fff; font-weight:bold; animation:pulse 1s infinite;
  opacity:0; transition:opacity 0.3s;
}
#voice-recording-indicator.show { opacity:1; }
@keyframes pulse {
  0% { transform:scale(1); }
  50% { transform:scale(1.2); }
  100% { transform:scale(1); }
}

/* –ü—Ä–æ—Ñ–∏–ª—å */
#profile-panel {
  position:fixed; top:70px; right:20px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  padding:16px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.4);
  display:none; z-index:1000; width:280px; max-height:80vh; overflow-y:auto;
  opacity:0; transform:translateY(-20px); transition:opacity 0.3s, transform 0.3s;
}
#profile-panel.show { display:flex; opacity:1; transform:translateY(0); }
#profile-panel input, #profile-panel textarea {
  width:100%; padding:8px; margin-top:8px; border-radius:4px; border:1px solid #555; background:#444; color:#fff; font-size:14px;
}
#profile-panel button {
  margin-top:12px; padding:8px 14px; border:none; border-radius:20px; font-weight:600; cursor:pointer; transition:background 0.2s;
}
#profile-panel .btn { background:#4caf50; color:#fff; }
#profile-panel .btn:hover { background:#45a049; }
#profile-panel .btn-secondary { background:#555; }
#profile-panel .btn-secondary:hover { background:#444; }

/* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ */
#extended-chat-creation {
  position:fixed; top:70px; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  display:flex; align-items:center; justify-content:center; z-index:9999;
  opacity:0; animation: fadeIn 0.3s forwards;
}
#extended-chat-creation.show { opacity:1; }
#extended-chat-box {
  background:#222; padding:20px; border-radius:8px; width:400px; max-width:90%; color:#fff;
  display:flex; flex-direction:column; gap:8px; transform:translateY(-20px); animation: slideDown 0.3s forwards;
}
@keyframes fadeIn {
  from { opacity:0; }
  to { opacity:1; }
}
@keyframes slideDown {
  from { transform:translateY(-20px); }
  to { transform:translateY(0); }
}
#extended-chat-box input {
  width:100%; padding:8px; border-radius:4px; border:1px solid #555; background:#444; color:#eee;
}
#extended-chat-box button {
  padding:8px 14px; border:none; border-radius:20px; font-weight:600; cursor:pointer; transition:background 0.2s, transform 0.2s;
}
#extended-chat-box .btn { background:#4caf50; color:#fff; }
#extended-chat-box .btn:hover { background:#45a049; transform:scale(1.05); }
#extended-chat-box .btn-secondary { background:#555; }
#extended-chat-box .btn-secondary:hover { background:#444; transform:scale(1.05); }

/* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
#context-menu {
  position:absolute; display:none; background:#222; border:1px solid #555; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.3);
  z-index:9999; overflow: hidden;
}
.ctx-item { padding:8px 12px; cursor:pointer; color:#fff; font-size:14px; transition: background 0.2s; }
.ctx-item:hover { background:#555; }

/* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —á–∞—Ç */
#full-chat-panel {
  position: fixed; top:70px; right:0; bottom:0; left:0;
  display:flex; flex-direction:column; background:#222; z-index:9998; display:none;
  animation: fadeIn 0.3s forwards;
}
#full-chat-header {
  padding:12px 20px; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center; background:#1f1f1f; color:#fff;
}
#full-chat-title { font-weight:600; font-size:16px; display:flex; align-items:center; }
#close-full-chat { background:#ef4444; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; color:#fff; font-weight:600; }
#full-chat-messages {
  flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:10px; background:#111;
}
#full-chat-message {
  width: calc(100% - 140px); padding:10px 14px; border-radius:20px; border:1px solid #555; background:#444; color:#eee; font-size:14px; outline:none; max-width: calc(100% - 140px);
}
#full-chat-send {
  margin-left:8px; padding:8px 14px; border:none; border-radius:20px; background:#25d366; color:#fff; font-size:14px; cursor:pointer; font-weight:600;
}
#close-full-chat { background:#ef4444; }
@media(max-width:900px){
  aside.sidebar { width: 92%; }
}
</style>
</head>
<body>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="header">
  <div class="title" style="position:relative; height:40px;">
    <!-- –¢–µ–∫—Å—Ç "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..." —Å loader -->
    <span id="update-text" style="opacity:0;">
      –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...<span class="loader"></span>
    </span>
    <!-- –õ–æ–≥–æ—Ç–∏–ø "Proar" -->
    <span id="logo-text" style="opacity:1;">Proar</span>
    <span id="unread-count" style="display:none;">0</span>
  </div>
  <div class="buttons">
    <button title="–ú–µ–Ω—é" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <button title="–ü—Ä–æ—Ñ–∏–ª—å" onclick="showProfile()"><i class="fas fa-user"></i></button>
    <button title="–°–æ–∑–¥–∞—Ç—å —á–∞—Ç" onclick="openExtendedChatCreation()"><i class="fas fa-plus"></i></button>
    <button title="–¢–µ–º–∞" id="theme-toggle"><i class="fas fa-moon"></i></button>
    <button title="–í—ã–π—Ç–∏" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
  </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div class="container">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>–ú–æ–∏ —á–∞—Ç—ã</h3>
    </div>
    <button id="new-chat-btn" onclick="openExtendedChatCreation()">–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ</button>
    <button id="search-username-btn" onclick="toggleSearchResults()">–ü–æ–∏—Å–∫ –ø–æ username</button>
    <div id="search-panel">
      <input id="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="searchEntities()"/>
    </div>
    <div id="chats"></div>
  </aside>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
  <section class="main" id="main">
    <div id="chat-header">
      <div>
        <span id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
        <span id="chat-status"></span>
        <span id="profile-badge" style="display:none;">‚úî</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="archiveChat()" class="btn" style="font-size:12px;">–ê—Ä—Ö–∏–≤</button>
        <button onclick="showFullChat()" class="btn" style="font-size:12px;">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
        <button onclick="showProfile()" class="btn" style="font-size:12px;"><i class="fas fa-cog"></i></button>
      </div>
    </div>
    <div id="messages" style="flex:1; padding:12px; overflow-y:auto; max-height: calc(100vh - 250px);"></div>
    <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <form id="input-area" onsubmit="event.preventDefault(); sendMessage()">
      <label id="file-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª"><i class="fas fa-paperclip"></i></label>
      <input type="file" id="file-input" style="display:none"/>
      <input id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"/>
      <button id="send-btn" type="submit"><i class="fas fa-paper-plane"></i></button>
      <button type="button" id="voice-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å" style="margin-left:auto; background:linear-gradient(135deg, #43e97b, #38f9d7); border:none; padding:8px 14px; border-radius:20px; cursor:pointer; transition:transform 0.2s;">
        <i class="fas fa-microphone"></i>
      </button>
    </form>
  </section>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<!-- –ü—Ä–æ—Ñ–∏–ª—å -->
<div id="profile-panel" style="display:none;">
  <h3 style="margin-top:0;">–ü—Ä–æ—Ñ–∏–ª—å</h3>
  <input id="profile-img" placeholder="–ê–≤–∞—Ç–∞—Ä URL" style="width:100%;"/>
  <input id="profile-name" placeholder="–ò–º—è" style="width:100%;"/>
  <input id="profile-username" placeholder="Username" style="width:100%;"/>
  <input id="profile-status" placeholder="–°—Ç–∞—Ç—É—Å" style="width:100%;"/>
  <div style="margin-top:12px; display:flex; justify-content:space-between;">
    <button class="btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn-secondary" onclick="closeProfile()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ -->
<div id="extended-chat-creation" style="display:none;">
  <div id="extended-chat-box">
    <h3 style="margin-top:0;">–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ</h3>
    <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" id="ext-chat-name"/>
    <input placeholder="–£—á–∞—Å—Ç–Ω–∏–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" id="ext-chat-members"/>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn" onclick="createExtendedChat()">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="btn-secondary" onclick="closeExtendedChat()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É -->
<div id="group-create-modal" style="display:none;">
  <div id="group-modal" style="background:#222; padding:20px; border-radius:8px; width:400px; max-width:90%; color:#fff; display:flex; flex-direction:column; gap:8px;">
    <h3 style="margin-top:0;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
    <input placeholder="–ò–º—è" id="group-name"/>
    <select id="group-privacy">
      <option value="public">–ü—É–±–ª–∏—á–Ω–∞—è</option>
      <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω–∞—è</option>
    </select>
    <input placeholder="–°—Å—ã–ª–∫–∞ –∏–ª–∏ username" id="group-link"/>
    <input placeholder="Username –≥—Ä—É–ø–ø—ã" id="group-username"/>
    <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" id="group-desc"></textarea>
    <input type="file" id="group-avatar"/>
    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="btn-secondary" onclick="closeGroupCreate()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div id="context-menu"></div>

<!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —á–∞—Ç -->
<div id="full-chat-panel">
  <div id="full-chat-header">
    <div id="full-chat-title">–ß–∞—Ç</div>
    <button id="close-full-chat" onclick="closeFullChat()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="full-chat-messages"></div>
  <form id="full-chat-input" onsubmit="event.preventDefault(); sendFullMessage()">
    <input id="full-chat-message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ"/>
    <button id="full-chat-send" type="submit"><i class="fas fa-paper-plane"></i></button>
  </form>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB-R3yavvxAaMeJ6bi_RneFuMkrqmHyE5g",
    authDomain: "proar-3cf77.firebaseapp.com",
    projectId: "proar-3cf77",
    storageBucket: "proar-3cf77.firebasestorage.app",
    messagingSenderId: "676918837096",
    appId: "1:676918837096:android:c7dbd6f8e44fcf230f60dd"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  let currentUser = null;
  let currentChatId = null;
  let chatsUnsub = null;
  let messagesUnsub = null;
  let replyToMessageId = null;
  let themeDark = true;

  // –¢–µ–º–∞
  if (localStorage.getItem('theme')==='light') {
    themeDark=false; document.body.classList.remove('dark');
  }
  document.getElementById('theme-toggle').onclick=()=>{
    themeDark=!themeDark; document.body.classList.toggle('dark', themeDark);
    localStorage.setItem('theme', themeDark?'dark':'light');
  };

  function encodeText(str) {
    const encoder = new TextEncoder();
    const bytes = encoder.encode(str);
    return btoa(String.fromCharCode(...bytes));
  }
  function decodeText(base64) {
    try {
      const bytesStr=atob(base64);
      const bytes=new Uint8Array([...bytesStr].map(c=>c.charCodeAt(0)));
      const decoder=new TextDecoder();
      return decoder.decode(bytes);
    } catch { return base64; }
  }

  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  function showAuthModal() {
    if (document.getElementById('auth-modal')) {
      document.getElementById('auth-modal').style.display='flex';
      return;
    }
    const div=document.createElement('div');
    div.id='auth-modal';
    div.style.position='fixed'; div.style.top='0'; div.style.left='0'; div.style.right='0'; div.style.bottom='0';
    div.style.background='rgba(0,0,0,0.8)'; div.style.display='flex';
    div.style.alignItems='center'; div.style.justifyContent='center'; div.style.zIndex='9999';
    div.innerHTML=`
      <div style="background:#222; padding:20px; border-radius:8px; width:320px; color:#fff; display:flex; flex-direction:column; gap:8px;">
        <h3 style="margin:0 0 6px 0;">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <input id="auth-email" placeholder="Email" style="width:100%; padding:8px;"/>
        <input id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="width:100%; padding:8px;"/>
        <div style="display:flex; justify-content:space-between;">
          <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
          <button class="btn-secondary" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
      </div>`;
    document.body.appendChild(div);
  }
  window.addEventListener('load', async ()=> {
  const updateTextEl = document.getElementById('update-text');
  const logoTextEl = document.getElementById('logo-text');

  // –ü–æ–∫–∞–∑–∞—Ç—å "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
  updateTextEl.style.opacity = 1;
  logoTextEl.style.opacity = 0;

  // –í—ã–ø–æ–ª–Ω–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é (–∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π)
  if (firebase.auth().currentUser) {
    currentUser=firebase.auth().currentUser;
    await postLoginInit();
  } else {
    showAuthModal();
  }

  // –ü–æ–¥–æ–∂–¥–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ 3-4 —Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
  // –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, —á—Ç–æ–±—ã –±—ã–ª–æ –¥–∏–Ω–∞–º–∏—á–Ω–æ, –ø–æ–¥–æ–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤/—Å–æ–æ–±—â–µ–Ω–∏–π
  // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, —Å–¥–µ–ª–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É 3-4 —Å–µ–∫, –∞ –ø–æ—Ç–æ–º –ø–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
  setTimeout(()=> {
    updateTextEl.style.opacity = 0;
    // –ü–æ—Å–ª–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "Proar"
    setTimeout(()=> {
      logoTextEl.style.opacity = 1;
      updateTextEl.style.display='none';
    }, 500); // –∂–¥—ë–º, –ø–æ–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
  }, 3500); // –∑–∞–¥–µ—Ä–∂–∫–∞ 3.5 —Å–µ–∫—É–Ω–¥—ã
});

  async function login() {
    const email=document.getElementById('auth-email').value.trim();
    const pass=document.getElementById('auth-password').value.trim();
    if (!email || !pass) { alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
    try {
      const cred=await firebase.auth().signInWithEmailAndPassword(email, pass);
      currentUser=cred.user;
      document.getElementById('auth-modal')?.remove();
      await postLoginInit();
    } catch(e) { alert(e.message); }
  }

  async function register() {
    const email=document.getElementById('auth-email').value.trim();
    const pass=document.getElementById('auth-password').value.trim();
    if (!email || !pass) { alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
    try {
      const cred=await firebase.auth().createUserWithEmailAndPassword(email, pass);
      currentUser=cred.user;
      document.getElementById('auth-modal')?.remove();
      await postLoginInit();
    } catch(e) { alert(e.message); }
  }

  async function postLoginInit() {
    await loadUserProfile();
    await loadChats();
    const lastChatId=localStorage.getItem('lastChatId');
    if (lastChatId) await openChat(lastChatId);
  }

  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      currentUser=user;
      await db.collection('users').doc(currentUser.uid).set({ username:currentUser.email, status:'–û–Ω–ª–∞–π–Ω' },{merge:true});
      document.getElementById('auth-modal')?.remove();
      await loadUserProfile();
      await loadChats();
      const lastChatId=localStorage.getItem('lastChatId');
      if (lastChatId) await openChat(lastChatId);
    } else {
      showAuthModal();
    }
  });

  async function logout() {
    await firebase.auth().signOut();
    currentUser=null;
    if (chatsUnsub) chatsUnsub();
    if (messagesUnsub) messagesUnsub();
    document.getElementById('chats').innerHTML='';
    document.getElementById('messages').innerHTML='';
    document.getElementById('chat-title').textContent='–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
    alert('–í—ã –≤—ã—à–ª–∏');
    showAuthModal();
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
  async function loadUserProfile() {
    if (!currentUser) return;
    const doc=await db.collection('users').doc(currentUser.uid).get();
    if (doc.exists) {
      const data=doc.data();
      // –ú–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ñ–∏–ª—è
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
  async function loadChats() {
    if (chatsUnsub) chatsUnsub();
    if (!currentUser) return;
    const q= db.collection('chats')
      .where('members','array-contains', currentUser.uid)
      .orderBy('updatedAt','desc');
    chatsUnsub=q.onSnapshot(snapshot => {
      const container=document.getElementById('chats');
      container.innerHTML='';
      snapshot.forEach(doc => {
        const chat=doc.data();
        const el=document.createElement('div');
        el.className='chat-item';
        el.id='chat-'+doc.id;
        el.onclick= ()=>{ openChat(doc.id); };
        if (currentChatId===doc.id) el.classList.add('active');

        const avatar=document.createElement('div');
        avatar.className='avatar';
        avatar.textContent= (chat.name?.charAt(0)||'–ß').toUpperCase();
        if (chat.avatarUrl) {
          avatar.style.backgroundImage=`url(${chat.avatarUrl})`;
          avatar.style.backgroundSize='cover'; avatar.style.backgroundPosition='center'; avatar.textContent='';
        }

        const info=document.createElement('div');
        info.className='chat-info';
        info.innerHTML= `
          <div class="chat-name">${chat.name||'–ß–∞—Ç'}</div>
          <div class="chat-last-message">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${chat.members?.length||0}</div>
        `;

        el.appendChild(avatar);
        el.appendChild(info);
        container.appendChild(el);
      });
    });
  }

  async function openChat(chatId) {
    const chatRef= db.collection('chats').doc(chatId);
    const chatDoc= await chatRef.get();
    if (!chatDoc.exists) return;
    const chatData=chatDoc.data();
    if (!chatData.members.includes(currentUser.uid)) { alert('–≠—Ç–æ—Ç —á–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤–∞–º'); return; }
    currentChatId=chatId;
    localStorage.setItem('lastChatId', chatId);

    document.querySelectorAll('.chat-item').forEach(e=>e.classList.remove('active'));
    const chatEl=document.getElementById('chat-'+chatId);
    if (chatEl) chatEl.classList.add('active');

    document.getElementById('chat-title').textContent='–ß–∞—Ç: '+(chatData.name||'–ß–∞—Ç');
    document.getElementById('chat-status').textContent='';

    if (messagesUnsub) messagesUnsub();
    messagesUnsub= chatRef.collection('messages')
      .orderBy('createdAt','asc')
      .onSnapshot(snapshot => {
        const div=document.getElementById('messages');
        div.innerHTML='';
        snapshot.forEach(doc=>{
          const msg=doc.data();
          const msgDiv=document.createElement('div');
          msgDiv.className='message ' + (msg.senderId===currentUser.uid?'sent':'recv');
          msgDiv.setAttribute('data-id',doc.id);

          // –¶–∏—Ç–∞—Ç–∞
          if (msg.replyToId) {
            const reply=document.createElement('div');
            reply.className='reply-preview';
            reply.textContent='–¶–∏—Ç–∞—Ç–∞: '+(msg.replyToText||'');
            msgDiv.appendChild(reply);
          }

          // –¢–µ–∫—Å—Ç
          if (msg.text) {
            const t=document.createElement('div');
            t.textContent=decodeText(msg.text);
            msgDiv.appendChild(t);
          }

          // –§–∞–π–ª
          if (msg.fileUrl) {
            const a=document.createElement('a');
            a.href=msg.fileUrl; a.target='_blank'; a.textContent='–§–∞–π–ª';
            msgDiv.appendChild(a);
          }

          // –í—Ä–µ–º—è
          const time=document.createElement('div');
          time.className='time';
          const date=new Date((msg.createdAt?.seconds||Date.now()/1000)*1000);
          time.textContent= date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          msgDiv.appendChild(time);

          // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
          msgDiv.oncontextmenu=(e)=>{
            e.preventDefault();
            showMessageContextMenu(e.pageX, e.pageY, doc.id, msg);
          };

          // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
          if (msg.senderId!==currentUser.uid) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            msgDiv.style.opacity='0.8';
          }

          div.appendChild(msgDiv);
        });
        div.scrollTop=div.scrollHeight;
      });
  }

  async function sendMessage() {
    const text=document.getElementById('message-input').value.trim();
    const fileInput=document.getElementById('file-input');
    if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
    if (!text && fileInput.files.length===0) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª'); return; }

    let fileUrl='';
    if (fileInput.files.length>0) {
      const file=fileInput.files[0];
      const ref=storage.ref().child('files/'+Date.now()+'_'+file.name);
      await ref.put(file);
      fileUrl= await ref.getDownloadURL();
    }

    const encodedText=text?encodeText(text):null;
    await db.collection('chats').doc(currentChatId).collection('messages').add({
      text: encodedText,
      fileUrl,
      senderId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      replyToId: replyToMessageId,
      replyToText: replyToMessageId ? (document.querySelector(`[data-id="${replyToMessageId}"]`)?.textContent || '') : null
    });
    document.getElementById('message-input').value='';
    document.getElementById('file-input').value='';
    replyToMessageId=null;
  }

  // –ì–æ–ª–æ—Å–æ–≤–∞—è
  let isRecording=false;
  let mediaRecorder=null;
  let chunks=[];
  const voiceBtn=document.getElementById('voice-btn');
  const voiceIndicator=document.createElement('div');
  voiceIndicator.id='voice-recording-indicator';

  voiceBtn.addEventListener('mousedown',startVoiceRecording);
  voiceBtn.addEventListener('mouseup',stopVoiceRecording);
  voiceBtn.addEventListener('touchstart',startVoiceRecording);
  voiceBtn.addEventListener('touchend',stopVoiceRecording);

  function startVoiceRecording(e) {
    e.preventDefault();
    if (isRecording) return;
    navigator.mediaDevices.getUserMedia({ audio:true }).then(stream=>{
      mediaRecorder=new MediaRecorder(stream);
      chunks=[];
      mediaRecorder.ondataavailable=e=>{ if (e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop=async ()=>{
        const blob=new Blob(chunks, {type:'audio/webm'});
        const ref=storage.ref().child('audio/'+Date.now()+'.webm');
        await ref.put(blob);
        const url=await ref.getDownloadURL();
        await db.collection('chats').doc(currentChatId).collection('messages').add({
          fileUrl:url,
          senderId:currentUser.uid,
          createdAt:firebase.firestore.FieldValue.serverTimestamp(),
          text:null,
          isAudio:true
        });
      };
      mediaRecorder.start();
      isRecording=true;
      showVoiceIndicator();
    }).catch(e=>{ alert('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω'); });
  }
  function stopVoiceRecording(e) {
    e.preventDefault();
    if (!isRecording || !mediaRecorder) return;
    mediaRecorder.stop();
    hideVoiceIndicator();
    isRecording=false;
  }

  function showVoiceIndicator() {
    document.body.appendChild(voiceIndicator);
    voiceIndicator.classList.add('show');
    voiceIndicator.innerHTML='<i class="fas fa-microphone"></i>&nbsp;–ó–∞–ø–∏—Å—å...';
  }
  function hideVoiceIndicator() {
    voiceIndicator.classList.remove('show');
    if (voiceIndicator.parentNode) voiceIndicator.parentNode.removeChild(voiceIndicator);
  }

  // –ñ–µ—Å—Ç –ø–æ—Ç—è–Ω–∏ –≤–≤–µ—Ä—Ö –¥–ª—è –∑–∞–ø–∏—Å–∏
  let startY=null;
  document.getElementById('voice-btn').addEventListener('touchstart', e=>{ startY=e.touches[0].clientY; });
  document.getElementById('voice-btn').addEventListener('touchmove', e=> {
    if (startY!==null) {
      const deltaY=e.touches[0].clientY-startY;
      if (deltaY<-50 && !isRecording) startVoiceRecording(e);
    }
  });
  document.getElementById('voice-btn').addEventListener('touchend', e=> {
    if (isRecording) stopVoiceRecording(e);
    startY=null;
  });

  // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
  function openExtendedChatCreation() {
    document.getElementById('extended-chat-creation').classList.add('show');
    document.getElementById('extended-chat-creation').style.display='flex';
  }
  function closeExtendedChat() {
    document.getElementById('extended-chat-creation').classList.remove('show');
    document.getElementById('extended-chat-creation').style.display='none';
  }
  async function createExtendedChat() {
    const name=document.getElementById('ext-chat-name').value.trim();
    const membersStr=document.getElementById('ext-chat-members').value.trim();
    if (!name || !membersStr) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'); return; }
    const membersArr=membersStr.split(',').map(s=>s.trim()).filter(s=>s);
    const membersUids=[];
    for (const m of membersArr) {
      if (m===currentUser.email || m===currentUser.uid) {
        if (!membersUids.includes(currentUser.uid)) membersUids.push(currentUser.uid);
      } else {
        const users= await db.collection('users').where('username','==',m).get();
        if (!users.empty) {
          users.forEach(u=>{ if (!membersUids.includes(u.id)) membersUids.push(u.id); });
        }
      }
    }
    if (!membersUids.includes(currentUser.uid)) membersUids.push(currentUser.uid);
    await db.collection('chats').add({ name, members: membersUids, updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    alert('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
    closeExtendedChat();
  }

  // –ü–æ–∏—Å–∫
  async function searchEntities() {
    const queryStr=document.getElementById('search-input').value.trim();
    if (!queryStr) {
      const el=document.getElementById('search-results');
      if (el) el.remove();
      return;
    }
    let resultsDiv=document.getElementById('search-results');
    if (!resultsDiv) {
      resultsDiv=document.createElement('div');
      resultsDiv.id='search-results';
      resultsDiv.style.position='absolute';
      resultsDiv.style.top='70px';
      resultsDiv.style.left='20px';
      resultsDiv.style.right='20px';
      resultsDiv.style.background='#222';
      resultsDiv.style.border='1px solid #555';
      resultsDiv.style.borderRadius='8px';
      resultsDiv.style.padding='8px';
      resultsDiv.style.zIndex='10000';
      resultsDiv.style.maxHeight='300px';
      resultsDiv.style.overflowY='auto';
      document.body.appendChild(resultsDiv);
    }
    resultsDiv.innerHTML='–ò—â–µ–º...';
    resultsDiv.style.display='block';

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const usersSnap= await db.collection('users')
      .where('username','>=',queryStr)
      .where('username','<=',queryStr+'\uf8ff')
      .get();

    // –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤
    const chatsSnap= await db.collection('chats')
      .where('name','>=',queryStr)
      .where('name','<=',queryStr+'\uf8ff')
      .get();

    resultsDiv.innerHTML='';

    usersSnap.forEach(u=>{
      const data=u.data();
      const div=document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #555';
      div.style.cursor='pointer';
      div.innerHTML=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.username||u.id}`;
      div.onclick=()=>{ openOrCreateChatWithUser(u.id, data.username||u.id); resultsDiv.style.display='none'; };
      resultsDiv.appendChild(div);
    });

    chatsSnap.forEach(c=>{
      const chat=c.data();
      const div=document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #555';
      div.style.cursor='pointer';
      div.innerHTML=`–ß–∞—Ç: ${chat.name}`;
      div.onclick=()=>{ openChat(c.id); resultsDiv.style.display='none'; };
      resultsDiv.appendChild(div);
    });
  }

  async function openOrCreateChatWithUser(userId, username) {
    const chatsRef= db.collection('chats');
    const query= await chatsRef.where('members','array-contains', currentUser.uid).get();
    let chatFound=null;
    query.forEach(c=>{
      const data=c.data();
      if (data.members.includes(userId)) chatFound=c.id;
    });
    if (chatFound) {
      openChat(chatFound);
    } else {
      const newRef= await db.collection('chats').add({
        name:'–ß–∞—Ç —Å '+(username||'–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
        members:[currentUser.uid, userId],
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      });
      openChat(newRef.id);
    }
  }

  function showFullChat() {
    if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
    document.getElementById('full-chat-panel').style.display='flex';
    loadFullMessages(currentChatId);
  }
  function closeFullChat() {
    document.getElementById('full-chat-panel').style.display='none';
    document.getElementById('full-chat-messages').innerHTML='';
    document.getElementById('full-chat-message').value='';
  }
  async function loadFullMessages(chatId) {
    const ref= db.collection('chats').doc(chatId);
    if (messagesUnsub) messagesUnsub();
    messagesUnsub= ref.collection('messages')
      .orderBy('createdAt','asc')
      .onSnapshot(snapshot => {
        const container=document.getElementById('full-chat-messages');
        container.innerHTML='';
        snapshot.forEach(doc=>{
          const msg=doc.data();
          const div=document.createElement('div');
          div.className='message ' + (msg.senderId===currentUser.uid?'sent':'recv');
          div.setAttribute('data-id',doc.id);

          if (msg.replyToId) {
            const reply=document.createElement('div');
            reply.className='reply-preview';
            reply.textContent='–¶–∏—Ç–∞—Ç–∞: '+(msg.replyToText||'');
            div.appendChild(reply);
          }

          if (msg.text) {
            const t=document.createElement('div');
            t.textContent=decodeText(msg.text);
            div.appendChild(t);
          }
          if (msg.fileUrl) {
            const a=document.createElement('a');
            a.href=msg.fileUrl; a.target='_blank'; a.textContent='–§–∞–π–ª';
            div.appendChild(a);
          }

          const time=document.createElement('div');
          time.className='time';
          const date=new Date((msg.createdAt?.seconds||Date.now()/1000)*1000);
          time.textContent= date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          div.appendChild(time);

          // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
          div.oncontextmenu=(e)=>{
            e.preventDefault();
            showMessageContextMenu(e.pageX, e.pageY, doc.id, msg);
          };

          // –û—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
          if (msg.senderId!==currentUser.uid) {
            div.style.opacity='0.8';
          }
          
          container.appendChild(div);
        });
        container.scrollTop=container.scrollHeight;
      });
  }

  async function sendFullMessage() {
    const msg= document.getElementById('full-chat-message').value.trim();
    if (!msg || !currentChatId) return;
    await db.collection('chats').doc(currentChatId).collection('messages').add({
      text: encodeText(msg),
      senderId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('full-chat-message').value='';
  }

  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–π
  function showMessageContextMenu(x,y,msgId,msgData) {
    const menu=document.getElementById('context-menu');
    menu.innerHTML='';
    menu.style.left=x+'px'; menu.style.top=y+'px'; menu.style.display='block';

    // –£–¥–∞–ª–µ–Ω–∏–µ
    const btnDel=document.createElement('div');
    btnDel.className='ctx-item'; btnDel.innerHTML='–£–¥–∞–ª–∏—Ç—å'; btnDel.onclick=()=>{
      deleteMessage(msgId); hideContextMenu();
    };
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
    const btnEdit=document.createElement('div');
    btnEdit.className='ctx-item'; btnEdit.innerHTML='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; btnEdit.onclick=()=>{
      if (msgData.senderId!==currentUser.uid) { alert('–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); hideContextMenu(); return; }
      editMessage(msgId, msgData.text); hideContextMenu();
    };
    // –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
    const btnReport=document.createElement('div');
    btnReport.className='ctx-item'; btnReport.innerHTML='–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è'; btnReport.onclick=()=>{
      reportMessage(msgId); hideContextMenu();
    };
    // –ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    const btnViewProfile=document.createElement('div');
    btnViewProfile.className='ctx-item'; btnViewProfile.innerHTML='–ü—Ä–æ—Ñ–∏–ª—å'; btnViewProfile.onclick=()=>{ viewUserProfile(msgData.senderId); hideContextMenu(); };
    // –ò–Ω—Ñ–æ –æ —á–∞—Ç–µ
    const btnViewChat=document.createElement('div');
    btnViewChat.className='ctx-item'; btnViewChat.innerHTML='–ò–Ω—Ñ–æ –æ —á–∞—Ç–µ'; btnViewChat.onclick=()=>{ viewChatInfo(currentChatId); hideContextMenu(); };

    // –ú–µ—Ç–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
    if (currentUser && currentUser.email=== 'mcarenko.artem.2012@gmail.com') {
      const devBadge=document.createElement('div');
      devBadge.className='ctx-item'; devBadge.innerHTML='üßë‚Äçüíª –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç';
      devBadge.style.fontWeight='bold'; devBadge.style.background='#3b82f6'; devBadge.style.color='#fff';
      devBadge.onclick=()=>{ alert('–≠—Ç–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞'); hideContextMenu(); };
      menu.appendChild(devBadge);
    }

    menu.appendChild(btnDel);
    menu.appendChild(btnEdit);
    menu.appendChild(btnReport);
    menu.appendChild(btnViewProfile);
    menu.appendChild(btnViewChat);
  }

  function hideContextMenu() {
    document.getElementById('context-menu').style.display='none';
  }

  document.addEventListener('click', ()=>{ hideContextMenu(); });

  // –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  async function deleteMessage(msgId) {
    if (!currentChatId || !msgId) return;
    await db.collection('chats').doc(currentChatId).collection('messages').doc(msgId).delete();
  }

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  async function editMessage(msgId, currentText) {
    const newText=prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', decodeText(currentText));
    if (newText===null) return;
    await db.collection('chats').doc(currentChatId).collection('messages').doc(msgId).update({ text: encodeText(newText) });
  }

  // –ñ–∞–ª–æ–±–∞
  async function reportMessage(msgId) {
    alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. –°–ø–∞—Å–∏–±–æ!');
    await db.collection('reports').add({
      messageId: msgId,
      chatId: currentChatId,
      reporterId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  // –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è
  async function viewUserProfile(userId) {
    const doc=await db.collection('users').doc(userId).get();
    if (!doc.exists) { alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    const data=doc.data();
    alert(`–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n–ò–º—è: ${data.name || ''}\nUsername: ${data.username || ''}\n–°—Ç–∞—Ç—É—Å: ${data.status || ''}`);
  }

  // –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ
  async function viewChatInfo(chatId) {
    const doc=await db.collection('chats').doc(chatId).get();
    if (!doc.exists) { alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    const data=doc.data();
    alert(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ:\n\n–ù–∞–∑–≤–∞–Ω–∏–µ: ${data.name}\n–£—á–∞—Å—Ç–Ω–∏–∫–∏: ${data.members.length}\n–°–æ–∑–¥–∞–Ω: ${new Date(data.createdAt?.seconds*1000).toLocaleString()}`);
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
  function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
  function showProfile() {
    const panel=document.getElementById('profile-panel');
    panel.style.display='flex';
    setTimeout(()=>{ panel.classList.add('show'); },10);
  }
  function closeProfile() {
    const panel=document.getElementById('profile-panel');
    panel.classList.remove('show');
    setTimeout(()=>{ panel.style.display='none'; },300);
  }
  async function saveProfile() {
    if (!currentUser) return;
    const username=document.getElementById('profile-username').value.trim();
    const name=document.getElementById('profile-name').value.trim();
    const status=document.getElementById('profile-status').value.trim();
    await db.collection('users').doc(currentUser.uid).set({ username, name, status }, { merge:true });
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
    closeProfile();
  }

  async function createChat() {
    const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞');
    if (!name) return;
    await db.collection('chats').add({ name, members:[currentUser.uid], updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    alert('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
  }

  async function archiveChat() {
    if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
    await db.collection('chats').doc(currentChatId).update({ archived:true });
    alert('–ß–∞—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω');
  }

  // –í—ã–∑–æ–≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö
  function openExtendedChat() { openExtendedChatCreation(); }
  function closeExtendedChat() {
    document.getElementById('extended-chat-creation').classList.remove('show');
    document.getElementById('extended-chat-creation').style.display='none';
  }
  async function createExtendedChat() {
    const name=document.getElementById('ext-chat-name').value.trim();
    const membersStr=document.getElementById('ext-chat-members').value.trim();
    if (!name || !membersStr) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'); return; }
    const membersArr=membersStr.split(',').map(s=>s.trim()).filter(s=>s);
    const membersUids=[];
    for (const m of membersArr) {
      if (m===currentUser.email || m===currentUser.uid) {
        if (!membersUids.includes(currentUser.uid)) membersUids.push(currentUser.uid);
      } else {
        const users= await db.collection('users').where('username','==',m).get();
        if (!users.empty) {
          users.forEach(u=>{ if (!membersUids.includes(u.id)) membersUids.push(u.id); });
        }
      }
    }
    if (!membersUids.includes(currentUser.uid)) membersUids.push(currentUser.uid);
    await db.collection('chats').add({ name, members: membersUids, updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    alert('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
    closeExtendedChat();
  }

  // –ü–æ–∏—Å–∫
  async function searchEntities() {
    const queryStr=document.getElementById('search-input').value.trim();
    if (!queryStr) {
      const el=document.getElementById('search-results');
      if (el) el.remove();
      return;
    }
    let resultsDiv=document.getElementById('search-results');
    if (!resultsDiv) {
      resultsDiv=document.createElement('div');
      resultsDiv.id='search-results';
      resultsDiv.style.position='absolute';
      resultsDiv.style.top='70px';
      resultsDiv.style.left='20px';
      resultsDiv.style.right='20px';
      resultsDiv.style.background='#222';
      resultsDiv.style.border='1px solid #555';
      resultsDiv.style.borderRadius='8px';
      resultsDiv.style.padding='8px';
      resultsDiv.style.zIndex='10000';
      resultsDiv.style.maxHeight='300px';
      resultsDiv.style.overflowY='auto';
      document.body.appendChild(resultsDiv);
    }
    resultsDiv.innerHTML='–ò—â–µ–º...';
    resultsDiv.style.display='block';

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const usersSnap= await db.collection('users')
      .where('username','>=',queryStr)
      .where('username','<=',queryStr+'\uf8ff')
      .get();

    // –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤
    const chatsSnap= await db.collection('chats')
      .where('name','>=',queryStr)
      .where('name','<=',queryStr+'\uf8ff')
      .get();

    resultsDiv.innerHTML='';

    usersSnap.forEach(u=>{
      const data=u.data();
      const div=document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #555';
      div.style.cursor='pointer';
      div.innerHTML=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.username||u.id}`;
      div.onclick=()=>{ openOrCreateChatWithUser(u.id, data.username||u.id); resultsDiv.style.display='none'; };
      resultsDiv.appendChild(div);
    });

    chatsSnap.forEach(c=>{
      const chat=c.data();
      const div=document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #555';
      div.style.cursor='pointer';
      div.innerHTML=`–ß–∞—Ç: ${chat.name}`;
      div.onclick=()=>{ openChat(c.id); resultsDiv.style.display='none'; };
      resultsDiv.appendChild(div);
    });
  }

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
  async function openOrCreateChatWithUser(userId, username) {
    const chatsRef= db.collection('chats');
    const query= await chatsRef.where('members','array-contains', currentUser.uid).get();
    let chatFound=null;
    query.forEach(c=>{
      const data=c.data();
      if (data.members.includes(userId)) chatFound=c.id;
    });
    if (chatFound) {
      openChat(chatFound);
    } else {
      const newRef= await db.collection('chats').add({
        name:'–ß–∞—Ç —Å '+(username||'–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
        members:[currentUser.uid, userId],
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      });
      openChat(newRef.id);
    }
  }

  function showFullChat() {
    if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
    document.getElementById('full-chat-panel').style.display='flex';
    loadFullMessages(currentChatId);
  }
  function closeFullChat() {
    document.getElementById('full-chat-panel').style.display='none';
    document.getElementById('full-chat-messages').innerHTML='';
    document.getElementById('full-chat-message').value='';
  }
  async function loadFullMessages(chatId) {
    const ref= db.collection('chats').doc(chatId);
    if (messagesUnsub) messagesUnsub();
    messagesUnsub= ref.collection('messages')
      .orderBy('createdAt','asc')
      .onSnapshot(snapshot => {
        const container=document.getElementById('full-chat-messages');
        container.innerHTML='';
        snapshot.forEach(doc=>{
          const msg=doc.data();
          const div=document.createElement('div');
          div.className='message ' + (msg.senderId===currentUser.uid?'sent':'recv');
          div.setAttribute('data-id',doc.id);

          if (msg.replyToId) {
            const reply=document.createElement('div');
            reply.className='reply-preview';
            reply.textContent='–¶–∏—Ç–∞—Ç–∞: '+(msg.replyToText||'');
            div.appendChild(reply);
          }

          if (msg.text) {
            const t=document.createElement('div');
            t.textContent=decodeText(msg.text);
            div.appendChild(t);
          }
          if (msg.fileUrl) {
            const a=document.createElement('a');
            a.href=msg.fileUrl; a.target='_blank'; a.textContent='–§–∞–π–ª';
            div.appendChild(a);
          }

          const time=document.createElement('div');
          time.className='time';
          const date=new Date((msg.createdAt?.seconds||Date.now()/1000)*1000);
          time.textContent= date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          div.appendChild(time);

          // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
          div.oncontextmenu=(e)=>{
            e.preventDefault();
            showMessageContextMenu(e.pageX, e.pageY, doc.id, msg);
          };

          // –û—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
          if (msg.senderId!==currentUser.uid) {
            div.style.opacity='0.8';
          }
          
          container.appendChild(div);
        });
        container.scrollTop=container.scrollHeight;
      });
  }

  async function sendFullMessage() {
    const msg= document.getElementById('full-chat-message').value.trim();
    if (!msg || !currentChatId) return;
    await db.collection('chats').doc(currentChatId).collection('messages').add({
      text: encodeText(msg),
      senderId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('full-chat-message').value='';
  }

  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
  function showMessageContextMenu(x,y,msgId,msgData) {
    const menu=document.getElementById('context-menu');
    menu.innerHTML='';
    menu.style.left=x+'px'; menu.style.top=y+'px'; menu.style.display='block';

    // –£–¥–∞–ª–µ–Ω–∏–µ
    const btnDel=document.createElement('div');
    btnDel.className='ctx-item'; btnDel.innerHTML='–£–¥–∞–ª–∏—Ç—å'; btnDel.onclick=()=>{
      deleteMessage(msgId); hideContextMenu();
    };
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
    const btnEdit=document.createElement('div');
    btnEdit.className='ctx-item'; btnEdit.innerHTML='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; btnEdit.onclick=()=>{
      if (msgData.senderId!==currentUser.uid) { alert('–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'); hideContextMenu(); return; }
      editMessage(msgId, msgData.text); hideContextMenu();
    };
    // –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
    const btnReport=document.createElement('div');
    btnReport.className='ctx-item'; btnReport.innerHTML='–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è'; btnReport.onclick=()=>{
      reportMessage(msgId); hideContextMenu();
    };
    // –ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    const btnViewProfile=document.createElement('div');
    btnViewProfile.className='ctx-item'; btnViewProfile.innerHTML='–ü—Ä–æ—Ñ–∏–ª—å'; btnViewProfile.onclick=()=>{ viewUserProfile(msgData.senderId); hideContextMenu(); };
    // –ò–Ω—Ñ–æ –æ —á–∞—Ç–µ
    const btnViewChat=document.createElement('div');
    btnViewChat.className='ctx-item'; btnViewChat.innerHTML='–ò–Ω—Ñ–æ –æ —á–∞—Ç–µ'; btnViewChat.onclick=()=>{ viewChatInfo(currentChatId); hideContextMenu(); };

    // –ú–µ—Ç–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
    if (currentUser && currentUser.email=== 'mcarenko.artem.2012@gmail.com') {
      const devBadge=document.createElement('div');
      devBadge.className='ctx-item'; devBadge.innerHTML='üßë‚Äçüíª –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç';
      devBadge.style.fontWeight='bold'; devBadge.style.background='#3b82f6'; devBadge.style.color='#fff';
      devBadge.onclick=()=>{ alert('–≠—Ç–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞'); hideContextMenu(); };
      menu.appendChild(devBadge);
    }

    menu.appendChild(btnDel);
    menu.appendChild(btnEdit);
    menu.appendChild(btnReport);
    menu.appendChild(btnViewProfile);
    menu.appendChild(btnViewChat);
  }

  function hideContextMenu() {
    document.getElementById('context-menu').style.display='none';
  }

  document.addEventListener('click', ()=>{ hideContextMenu(); });

  // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  async function deleteMessage(msgId) {
    if (!currentChatId || !msgId) return;
    await db.collection('chats').doc(currentChatId).collection('messages').doc(msgId).delete();
  }

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  async function editMessage(msgId, currentText) {
    const newText=prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', decodeText(currentText));
    if (newText===null) return;
    await db.collection('chats').doc(currentChatId).collection('messages').doc(msgId).update({ text: encodeText(newText) });
  }

  // –ñ–∞–ª–æ–±–∞
  async function reportMessage(msgId) {
    alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. –°–ø–∞—Å–∏–±–æ!');
    await db.collection('reports').add({
      messageId: msgId,
      chatId: currentChatId,
      reporterId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  // –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è
  async function viewUserProfile(userId) {
    const doc=await db.collection('users').doc(userId).get();
    if (!doc.exists) { alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    const data=doc.data();
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ —ç—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
    let infoText=`–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n–ò–º—è: ${data.name || ''}\nUsername: ${data.username || ''}\n–°—Ç–∞—Ç—É—Å: ${data.status || ''}`;
    if (userId==='mcarenko.artem.2012@gmail.com') {
      infoText+=`\n\n‚úÖ –≠—Ç–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞`;
    }
    alert(infoText);
  }

  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ
  async function viewChatInfo(chatId) {
    const doc=await db.collection('chats').doc(chatId).get();
    if (!doc.exists) { alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    const data=doc.data();
    alert(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ:\n\n–ù–∞–∑–≤–∞–Ω–∏–µ: ${data.name}\n–£—á–∞—Å—Ç–Ω–∏–∫–∏: ${data.members.length}\n–°–æ–∑–¥–∞–Ω: ${new Date(data.createdAt?.seconds*1000).toLocaleString()}`);
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
  function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
  function showProfile() {
    const panel=document.getElementById('profile-panel');
    panel.style.display='flex';
    setTimeout(()=>{ panel.classList.add('show'); },10);
  }
  function closeProfile() {
    const panel=document.getElementById('profile-panel');
    panel.classList.remove('show');
    setTimeout(()=>{ panel.style.display='none'; },300);
  }
  async function saveProfile() {
    if (!currentUser) return;
    const username=document.getElementById('profile-username').value.trim();
    const name=document.getElementById('profile-name').value.trim();
    const status=document.getElementById('profile-status').value.trim();
    await db.collection('users').doc(currentUser.uid).set({ username, name, status }, { merge:true });
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
    closeProfile();
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ –≤—Ä—É—á–Ω—É—é
  async function createChat() {
    const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞');
    if (!name) return;
    await db.collection('chats').add({ name, members:[currentUser.uid], updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    alert('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
  }

  // –ê—Ä—Ö–∏–≤
  async function archiveChat() {
    if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
    await db.collection('chats').doc(currentChatId).update({ archived:true });
    alert('–ß–∞—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω');
  }

  // –í—ã–∑–æ–≤—ã
  function openExtendedChat() { openExtendedChatCreation(); }
  function closeExtendedChat() { document.getElementById('extended-chat-creation').classList.remove('show'); document.getElementById('extended-chat-creation').style.display='none'; }
  async function createExtendedChat() {
    const name=document.getElementById('ext-chat-name').value.trim();
    const membersStr=document.getElementById('ext-chat-members').value.trim();
    if (!name || !membersStr) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'); return; }
    const membersArr=membersStr.split(',').map(s=>s.trim()).filter(s=>s);
    const membersUids=[];
    for (const m of membersArr) {
      if (m===currentUser.email || m===currentUser.uid) {
        if (!membersUids.includes(currentUser.uid)) membersUids.push(currentUser.uid);
      } else {
        const users= await db.collection('users').where('username','==',m).get();
        if (!users.empty) {
          users.forEach(u=>{ if (!membersUids.includes(u.id)) membersUids.push(u.id); });
        }
      }
    }
    if (!membersUids.includes(currentUser.uid)) membersUids.push(currentUser.uid);
    await db.collection('chats').add({ name, members: membersUids, updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    alert('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
    closeExtendedChat();
  }

  // –ü–æ–∏—Å–∫
  async function searchEntities() {
    const queryStr=document.getElementById('search-input').value.trim();
    if (!queryStr) {
      const el=document.getElementById('search-results');
      if (el) el.remove();
      return;
    }
    let resultsDiv=document.getElementById('search-results');
    if (!resultsDiv) {
      resultsDiv=document.createElement('div');
      resultsDiv.id='search-results';
      resultsDiv.style.position='absolute';
      resultsDiv.style.top='70px';
      resultsDiv.style.left='20px';
      resultsDiv.style.right='20px';
      resultsDiv.style.background='#222';
      resultsDiv.style.border='1px solid #555';
      resultsDiv.style.borderRadius='8px';
      resultsDiv.style.padding='8px';
      resultsDiv.style.zIndex='10000';
      resultsDiv.style.maxHeight='300px';
      resultsDiv.style.overflowY='auto';
      document.body.appendChild(resultsDiv);
    }
    resultsDiv.innerHTML='–ò—â–µ–º...';
    resultsDiv.style.display='block';

    const usersSnap= await db.collection('users')
      .where('username','>=',queryStr)
      .where('username','<=',queryStr+'\uf8ff')
      .get();

    const chatsSnap= await db.collection('chats')
      .where('name','>=',queryStr)
      .where('name','<=',queryStr+'\uf8ff')
      .get();

    resultsDiv.innerHTML='';

    usersSnap.forEach(u=>{
      const data=u.data();
      const div=document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #555';
      div.style.cursor='pointer';
      div.innerHTML=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.username||u.id}`;
      div.onclick=()=>{ openOrCreateChatWithUser(u.id, data.username||u.id); resultsDiv.style.display='none'; };
      resultsDiv.appendChild(div);
    });

    chatsSnap.forEach(c=>{
      const chat=c.data();
      const div=document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #555';
      div.style.cursor='pointer';
      div.innerHTML=`–ß–∞—Ç: ${chat.name}`;
      div.onclick=()=>{ openChat(c.id); resultsDiv.style.display='none'; };
      resultsDiv.appendChild(div);
    });
  }

  // –û—Ç–∫—Ä—ã—Ç–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
  async function openOrCreateChatWithUser(userId, username) {
    const chatsRef= db.collection('chats');
    const query= await chatsRef.where('members','array-contains', currentUser.uid).get();
    let chatFound=null;
    query.forEach(c=>{
      const data=c.data();
      if (data.members.includes(userId)) chatFound=c.id;
    });
    if (chatFound) {
      openChat(chatFound);
    } else {
      const newRef= await db.collection('chats').add({
        name:'–ß–∞—Ç —Å '+(username||'–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
        members:[currentUser.uid, userId],
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      });
      openChat(newRef.id);
    }
  }

  function showFullChat() {
    if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
    document.getElementById('full-chat-panel').style.display='flex';
    loadFullMessages(currentChatId);
  }
  function closeFullChat() {
    document.getElementById('full-chat-panel').style.display='none';
    document.getElementById('full-chat-messages').innerHTML='';
    document.getElementById('full-chat-message').value='';
  }
  async function loadFullMessages(chatId) {
    const ref= db.collection('chats').doc(chatId);
    if (messagesUnsub) messagesUnsub();
    messagesUnsub= ref.collection('messages')
      .orderBy('createdAt','asc')
      .onSnapshot(snapshot => {
        const container=document.getElementById('full-chat-messages');
        container.innerHTML='';
        snapshot.forEach(doc=>{
          const msg=doc.data();
          const div=document.createElement('div');
          div.className='message ' + (msg.senderId===currentUser.uid?'sent':'recv');
          div.setAttribute('data-id',doc.id);

          if (msg.replyToId) {
            const reply=document.createElement('div');
            reply.className='reply-preview';
            reply.textContent='–¶–∏—Ç–∞—Ç–∞: '+(msg.replyToText||'');
            div.appendChild(reply);
          }

          if (msg.text) {
            const t=document.createElement('div');
            t.textContent=decodeText(msg.text);
            div.appendChild(t);
          }
          if (msg.fileUrl) {
            const a=document.createElement('a');
            a.href=msg.fileUrl; a.target='_blank'; a.textContent='–§–∞–π–ª';
            div.appendChild(a);
          }

          const time=document.createElement('div');
          time.className='time';
          const date=new Date((msg.createdAt?.seconds||Date.now()/1000)*1000);
          time.textContent= date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          div.appendChild(time);

          div.oncontextmenu=(e)=>{
            e.preventDefault();
            showMessageContextMenu(e.pageX, e.pageY, doc.id, msg);
          };

          if (msg.senderId!==currentUser.uid) {
            div.style.opacity='0.8';
          }
          
          container.appendChild(div);
        });
        container.scrollTop=container.scrollHeight;
      });
  }

  async function sendFullMessage() {
    const msg= document.getElementById('full-chat-message').value.trim();
    if (!msg || !currentChatId) return;
    await db.collection('chats').doc(currentChatId).collection('messages').add({
      text: encodeText(msg),
      senderId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('full-chat-message').value='';
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
  function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
  function showProfile() {
    const panel=document.getElementById('profile-panel');
    panel.style.display='flex';
    setTimeout(()=>{ panel.classList.add('show'); },10);
  }
  function closeProfile() {
    const panel=document.getElementById('profile-panel');
    panel.classList.remove('show');
    setTimeout(()=>{ panel.style.display='none'; },300);
  }
  async function saveProfile() {
    if (!currentUser) return;
    const username=document.getElementById('profile-username').value.trim();
    const name=document.getElementById('profile-name').value.trim();
    const status=document.getElementById('profile-status').value.trim();
    await db.collection('users').doc(currentUser.uid).set({ username, name, status }, { merge:true });
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
    closeProfile();
  }

  // –°–æ–∑–¥–∞—Ç—å —á–∞—Ç –≤—Ä—É—á–Ω—É—é
  async function createChat() {
    const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞');
    if (!name) return;
    await db.collection('chats').add({ name, members:[currentUser.uid], updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    alert('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
  }

  async function archiveChat() {
    if (!currentChatId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç'); return; }
    await db.collection('chats').doc(currentChatId).update({ archived:true });
    alert('–ß–∞—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω');
  }

</script>
<script>
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
  document.getElementById('send-btn').onclick=()=>{ sendMessage(); };
  document.getElementById('voice-btn').onclick=()=>{};
  document.getElementById('search-input').oninput=()=>{ toggleSearchResults(); };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  window.addEventListener('load', ()=> {
    if (firebase.auth().currentUser) {
      currentUser=firebase.auth().currentUser;
      postLoginInit();
    } else {
      showAuthModal();
    }
  });
</script>
</body>
</html>